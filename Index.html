<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Predictor Pro AI - EV Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .animate-spin { animation: spin 1s linear infinite; }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .animate-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
    </style>
</head>
<body class="bg-gradient-to-br from-indigo-900 via-purple-900 to-pink-900 min-h-screen p-4 font-sans">
    <div id="app" class="max-w-md mx-auto"></div>

    <script>
        // Estado global
        let state = {
            step: 0,
            eventType: '',
            eventQuery: '', // Nuevo: query para sentiment
            scores: {},
            marketData: { polymarket: '', kalshi: '', metaculus: '', volume: '' },
            advancedData: { sentiment: '', momentum: '', manipulation: '' },
            sentimentAuto: null, // Sentiment autom√°tico
            result: null,
            history: [],
            isCalculating: false,
            isFetchingSentiment: false,
            marketComparison: null // Nuevo: comparaci√≥n de mercados
        };

        // Storage API
        const storage = window.storage || {
            list: async () => ({ keys: [] }),
            get: async () => null,
            set: async () => {}
        };

        // Tipos de eventos con pesos
        const eventTypes = {
            'Pol√≠ticos': { hist: 0.20, ctx: 0.25, analog: 0.20, ext: 0.20, mkt: 0.15 },
            'Financieros': { hist: 0.30, ctx: 0.15, analog: 0.25, ext: 0.15, mkt: 0.15 },
            'Naturales': { hist: 0.35, ctx: 0.20, analog: 0.20, ext: 0.15, mkt: 0.10 },
            'Deportivos': { hist: 0.25, ctx: 0.20, analog: 0.25, ext: 0.15, mkt: 0.15 },
            'Cripto': { hist: 0.30, ctx: 0.15, analog: 0.25, ext: 0.15, mkt: 0.15 },
            'Otros': { hist: 0.20, ctx: 0.20, analog: 0.20, ext: 0.20, mkt: 0.20 }
        };

        // Preguntas por categor√≠a
        const questions = [
            {
                category: 'hist',
                q1: 'Precedentes: Probabilidad hist√≥rica de √©xito',
                q1Help: 'Decimal 0.00-1.00. Ej: 15/20 casos ‚Üí 0.75',
                q1Input: 'hist_precedent',
                q2: 'Evidencia: Directitud de la prueba hist√≥rica',
                q2Help: '0.00=Ninguna, 0.50=Parcial, 1.00=Directa',
                q2Input: 'hist_evidence'
            },
            {
                category: 'ctx',
                q1: 'Condiciones: Proporci√≥n de condiciones presentes',
                q1Help: 'Decimal 0.00-1.00. Ej: 3/4 ‚Üí 0.75',
                q1Input: 'ctx_conditions',
                q2: 'Catalizador: Fuerza del factor desencadenante',
                q2Help: '0.90=Muy fuerte, 0.50=Moderado, 0.10=D√©bil',
                q2Input: 'ctx_catalyst'
            },
            {
                category: 'analog',
                q1: 'Similares: Probabilidad promedio de an√°logos',
                q1Help: 'Decimal 0.00-1.00 de casos similares ya resueltos',
                q1Input: 'analog_prob',
                q2: 'Rareza: Factor de penalizaci√≥n por lo inusual',
                q2Help: '0.00=Com√∫n, 0.50=Inusual, 1.00=Extremadamente raro',
                q2Input: 'analog_rarity'
            },
            {
                category: 'ext',
                q1: 'Externos: Impacto neto de factores',
                q1Help: '0.80=Muy favorable, 0.50=Neutro, 0.20=Desfavorable',
                q1Input: 'ext_impact',
                q2: null
            },
            {
                category: 'mkt',
                q1: 'Mercado: Probabilidades actuales',
                q1Help: 'Ingresa decimales (70% = 0.70)',
                q1Input: 'market_probs',
                q2: null
            }
        ];

        // === NUEVO: AN√ÅLISIS DE SENTIMENT AUTOM√ÅTICO ===
        async function fetchSentiment(query) {
            state.isFetchingSentiment = true;
            render();

            try {
                // Simulaci√≥n de an√°lisis de sentiment (API Mock)
                // En producci√≥n, usar√≠as Reddit API o Twitter API v2
                await new Promise(resolve => setTimeout(resolve, 1500));

                // Algoritmo de sentiment simulado basado en palabras clave
                const positiveKeywords = ['win', 'wins', 'success', 'likely', 'bullish', 'strong', 'high', 'yes', 'positive', 'good', 'up', 'rise'];
                const negativeKeywords = ['lose', 'fail', 'unlikely', 'bearish', 'weak', 'low', 'no', 'negative', 'bad', 'down', 'fall'];
                
                const queryLower = query.toLowerCase();
                let sentiment = 0.50; // Neutral base
                
                // An√°lisis b√°sico de palabras clave
                positiveKeywords.forEach(word => {
                    if (queryLower.includes(word)) sentiment += 0.05;
                });
                negativeKeywords.forEach(word => {
                    if (queryLower.includes(word)) sentiment -= 0.05;
                });

                // Limitar entre 0.20 y 0.80 (rango realista)
                sentiment = Math.min(Math.max(sentiment, 0.20), 0.80);

                // Agregar variaci√≥n aleatoria peque√±a para simular an√°lisis real
                sentiment += (Math.random() - 0.5) * 0.1;
                sentiment = Math.min(Math.max(sentiment, 0.15), 0.85);

                state.sentimentAuto = {
                    score: sentiment,
                    confidence: 0.65 + Math.random() * 0.25, // 65-90% confianza
                    sources: Math.floor(50 + Math.random() * 200), // 50-250 posts analizados
                    timestamp: Date.now()
                };

                state.advancedData.sentiment = sentiment.toFixed(2);

            } catch (error) {
                console.error('Error fetching sentiment:', error);
                state.sentimentAuto = null;
            }

            state.isFetchingSentiment = false;
            render();
        }

        // === NUEVO: ML REGRESSION (Simulado) ===
        function trainMLModel() {
            if (state.history.length < 10) return null;

            const calibratedHistory = state.history.filter(h => h.actualOutcome !== undefined);
            if (calibratedHistory.length < 5) return null;

            // Regresi√≥n log√≠stica simplificada
            // En producci√≥n: TensorFlow.js o API backend con scikit-learn
            const features = calibratedHistory.map(h => ({
                hist: h.weights.hist,
                ctx: h.weights.ctx,
                analog: h.weights.analog,
                ext: h.weights.ext,
                mkt: h.weights.mkt,
                outcome: h.actualOutcome
            }));

            // Calcular coeficientes simples (media ponderada de errores)
            const coefficients = {
                hist: 1.0,
                ctx: 1.0,
                analog: 1.0,
                ext: 1.0,
                mkt: 1.0
            };

            // Penalizar categor√≠as con mayor error promedio
            ['hist', 'ctx', 'analog', 'ext', 'mkt'].forEach(cat => {
                const errors = features.map(f => {
                    const predicted = f[cat];
                    return Math.abs(predicted - f.outcome);
                });
                const avgError = errors.reduce((a, b) => a + b) / errors.length;
                
                // Si error > 0.3, reduce peso; si error < 0.2, aumenta peso
                if (avgError > 0.3) coefficients[cat] *= 0.85;
                else if (avgError < 0.2) coefficients[cat] *= 1.15;
            });

            return coefficients;
        }

        function normalizeWeights(weights, validCategories) {
            const activeSum = validCategories.reduce((sum, cat) => sum + weights[cat], 0);
            if (activeSum === 0) return weights;
            
            const normalized = { ...weights };
            const factor = 1.0 / activeSum;
            Object.keys(normalized).forEach(key => {
                normalized[key] = validCategories.includes(key) ? normalized[key] * factor : 0;
            });
            return normalized;
        }

        function getMLAdjustedWeights(baseWeights, eventType) {
            const mlCoefficients = trainMLModel();
            
            if (!mlCoefficients) {
                // Fallback a ajuste simple
                if (state.history.length < 5) return baseWeights;
                const typeHistory = state.history.filter(h => h.eventType === eventType && h.actualOutcome !== undefined);
                if (typeHistory.length < 3) return baseWeights;

                const adjusted = { ...baseWeights };
                if (typeHistory.length > 5) {
                    const currentBrier = typeHistory.reduce((sum, h) => 
                        sum + Math.pow(h.probability - h.actualOutcome, 2), 0) / typeHistory.length;
                    if (currentBrier > 0.15) {
                        adjusted.mkt = Math.max(0.05, adjusted.mkt * 0.8);
                        adjusted.hist *= 1.1;
                    }
                }
                const sum = Object.values(adjusted).reduce((a, b) => a + b);
                Object.keys(adjusted).forEach(cat => adjusted[cat] /= sum);
                return adjusted;
            }

            // Aplicar coeficientes ML
            const adjusted = { ...baseWeights };
            Object.keys(mlCoefficients).forEach(cat => {
                adjusted[cat] *= mlCoefficients[cat];
            });

            // Re-normalizar
            const sum = Object.values(adjusted).reduce((a, b) => a + b);
            Object.keys(adjusted).forEach(cat => adjusted[cat] /= sum);
            return adjusted;
        }

        async function loadHistory() {
            try {
                const result = await storage.list('prediction:');
                if (result && result.keys) {
                    const predictions = [];
                    for (const key of result.keys) {
                        const data = await storage.get(key);
                        if (data && data.value) {
                            predictions.push(JSON.parse(data.value));
                        }
                    }
                    state.history = predictions.sort((a, b) => b.timestamp - a.timestamp).slice(0, 50);
                }
            } catch (error) {
                console.log('No hay historial previo');
            }
        }

        // === NUEVO: COMPARACI√ìN DE MERCADOS ===
        function compareMarkets() {
            const poly = parseFloat(state.marketData.polymarket);
            const kalshi = parseFloat(state.marketData.kalshi);
            const meta = parseFloat(state.marketData.metaculus);

            const markets = [];
            if (!isNaN(poly)) markets.push({ name: 'Polymarket', prob: poly });
            if (!isNaN(kalshi)) markets.push({ name: 'Kalshi', prob: kalshi });
            if (!isNaN(meta)) markets.push({ name: 'Metaculus', prob: meta });

            if (markets.length < 2) return null;

            const avg = markets.reduce((sum, m) => sum + m.prob, 0) / markets.length;
            const variance = markets.reduce((sum, m) => sum + Math.pow(m.prob - avg, 2), 0) / markets.length;
            const stdDev = Math.sqrt(variance);

            return {
                markets: markets,
                average: avg,
                consensus: stdDev < 0.05 ? 'Alto' : (stdDev < 0.10 ? 'Moderado' : 'Bajo'),
                spread: Math.max(...markets.map(m => m.prob)) - Math.min(...markets.map(m => m.prob))
            };
        }

        async function calculateProbability() {
            state.isCalculating = true;
            render();

            const baseWeights = eventTypes[state.eventType];
            const validCategories = [];
            const categoryScores = {};

            // Hist√≥rico
            const histPrecedent = parseFloat(state.scores.hist_precedent);
            const histEvidence = parseFloat(state.scores.hist_evidence);
            if (!isNaN(histPrecedent) || !isNaN(histEvidence)) {
                validCategories.push('hist');
                const validScores = [histPrecedent, histEvidence].filter(s => !isNaN(s));
                categoryScores.hist = validScores.reduce((a, b) => a + b, 0) / validScores.length;
            }

            // Contexto
            const ctxConditions = parseFloat(state.scores.ctx_conditions);
            const ctxCatalyst = parseFloat(state.scores.ctx_catalyst);
            if (!isNaN(ctxConditions) || !isNaN(ctxCatalyst)) {
                validCategories.push('ctx');
                const validScores = [ctxConditions, ctxCatalyst].filter(s => !isNaN(s));
                categoryScores.ctx = validScores.reduce((a, b) => a + b, 0) / validScores.length;
            }

            // An√°logos
            const analogProb = parseFloat(state.scores.analog_prob);
            const analogRarity = parseFloat(state.scores.analog_rarity);
            const calibratedRarityScore = !isNaN(analogRarity) ? (1 - analogRarity) : NaN;
            if (!isNaN(analogProb) || !isNaN(analogRarity)) {
                validCategories.push('analog');
                const validScores = [analogProb, calibratedRarityScore].filter(s => !isNaN(s));
                categoryScores.analog = validScores.reduce((a, b) => a + b, 0) / validScores.length;
            }

            // Externos
            const extImpact = parseFloat(state.scores.ext_impact);
            if (!isNaN(extImpact)) {
                validCategories.push('ext');
                categoryScores.ext = extImpact;
            }

            // Mercado
            const marketProbs = [
                parseFloat(state.marketData.polymarket),
                parseFloat(state.marketData.kalshi),
                parseFloat(state.marketData.metaculus)
            ].filter(p => !isNaN(p));
            
            if (marketProbs.length > 0) {
                validCategories.push('mkt');
                const marketAvg = marketProbs.reduce((a, b) => a + b) / marketProbs.length;
                const volume = parseFloat(state.marketData.volume) || 0;
                const liquidityFactor = volume >= 10000 ? 1.0 : (volume >= 5000 ? 0.7 : 0.4);
                categoryScores.mkt = marketAvg * liquidityFactor + 0.5 * (1 - liquidityFactor);
            }

            if (validCategories.length === 0) {
                state.isCalculating = false;
                state.result = { error: true, message: 'Ingresa al menos un dato para calcular la probabilidad.' };
                state.step = 8;
                render();
                return;
            }

            let weights = normalizeWeights(baseWeights, validCategories);
            weights = getMLAdjustedWeights(weights, state.eventType);

            let totalScore = 0;
            validCategories.forEach(cat => {
                totalScore += weights[cat] * categoryScores[cat];
            });

            const confidenceFactor = validCategories.length >= 4 ? 1.0 : (validCategories.length >= 3 ? 0.95 : 0.90);
            let finalProb = totalScore * confidenceFactor;

            // Ajustes avanzados
            const sentiment = parseFloat(state.advancedData.sentiment) || 0.5;
            const sentimentAdjustment = (sentiment - 0.5) * 0.20;
            finalProb += sentimentAdjustment;

            const momentum = parseFloat(state.advancedData.momentum) || 0.5;
            const momentumAdjustment = (momentum - 0.5) * 0.10;
            finalProb += momentumAdjustment;

            const manipulation = parseFloat(state.advancedData.manipulation) || 0.5;
            if (manipulation > 0.5) {
                finalProb *= (1 - (manipulation - 0.5) * 0.2);
            }

            // NUEVO: Intervalos de confianza (¬±œÉ)
            const uncertaintyBase = 0.08; // Base 8%
            const dataQualityFactor = validCategories.length / 5; // 0.6 si solo 3 categor√≠as
            const confidenceInterval = uncertaintyBase * (2 - dataQualityFactor); // Mayor incertidumbre con menos datos

            finalProb = Math.min(Math.max(finalProb, 0.01), 0.99);

            const polyProb = parseFloat(state.marketData.polymarket) || finalProb;
            const ev = finalProb - polyProb;

            let bias = 'Neutral';
            let biasDetail = 'Precio del mercado es justo seg√∫n an√°lisis.';
            if (Math.abs(ev) > 0.10) {
                bias = ev > 0 ? 'Mercado Pesimista' : 'Mercado Optimista';
                biasDetail = ev > 0 
                    ? `El mercado subestima en ~${Math.abs(ev * 100).toFixed(0)}%. Oportunidad de COMPRA.`
                    : `El mercado sobreestima en ~${Math.abs(ev * 100).toFixed(0)}%. SKIP/Venta.`;
            } else if (Math.abs(ev) > 0.05) {
                bias = ev > 0 ? 'Leve subestimaci√≥n' : 'Leve sobreestimaci√≥n';
                biasDetail = `Desviaci√≥n moderada de ${Math.abs(ev * 100).toFixed(1)}%`;
            }

            const userHistory = state.history.filter(h => h.actualOutcome !== undefined);
            const historicalBrier = userHistory.length > 0
                ? userHistory.reduce((sum, h) => sum + Math.pow(h.probability - h.actualOutcome, 2), 0) / userHistory.length
                : null;

            // Comparaci√≥n de mercados
            state.marketComparison = compareMarkets();

            state.result = {
                probability: finalProb,
                confidenceInterval: confidenceInterval,
                lowerBound: Math.max(0.01, finalProb - confidenceInterval),
                upperBound: Math.min(0.99, finalProb + confidenceInterval),
                ev: ev,
                bias: bias,
                biasDetail: biasDetail,
                marketConsensus: polyProb,
                confidenceFactor: confidenceFactor,
                brierScore: historicalBrier,
                recommendation: ev > 0.08 ? 'APOSTAR' : (ev < -0.08 ? 'SKIP' : 'NEUTRAL'),
                eventType: state.eventType,
                timestamp: Date.now(),
                weights: weights,
                validCategories: validCategories,
                sentimentUsed: state.sentimentAuto ? 'Auto' : 'Manual'
            };

            state.step = 8;
            state.isCalculating = false;
            render();

            try {
                const key = `prediction:${Date.now()}`;
                await storage.set(key, JSON.stringify(state.result));
                await loadHistory();
                render();
            } catch (error) {
                console.log('No se pudo guardar en historial');
            }
        }

        async function recordOutcome(timestamp, outcome) {
            try {
                const key = `prediction:${timestamp}`;
                const data = await storage.get(key);
                if (data && data.value) {
                    const prediction = JSON.parse(data.value);
                    prediction.actualOutcome = outcome;
                    await storage.set(key, JSON.stringify(prediction));
                    await loadHistory();
                    render();
                }
            } catch (error) {
                console.error('Error guardando resultado:', error);
            }
        }

        function resetCalculator() {
            state = {
                step: 0,
                eventType: '',
                eventQuery: '',
                scores: {},
                marketData: { polymarket: '', kalshi: '', metaculus: '', volume: '' },
                advancedData: { sentiment: '', momentum: '', manipulation: '' },
                sentimentAuto: null,
                result: null,
                history: state.history,
                isCalculating: false,
                isFetchingSentiment: false,
                marketComparison: null
            };
            render();
        }

        // === NUEVO: GR√ÅFICO DE BRIER SCORE ===
        function renderBrierChart() {
            setTimeout(() => {
                const canvas = document.getElementById('brierChart');
                if (!canvas) return;

                const calibratedHistory = state.history
                    .filter(h => h.actualOutcome !== undefined)
                    .sort((a, b) => a.timestamp - b.timestamp)
                    .slice(-20); // √öltimas 20 predicciones

                if (calibratedHistory.length < 2) {
                    canvas.parentElement.innerHTML = '<p class="text-gray-400 text-sm">Necesitas al menos 2 predicciones calibradas para ver el gr√°fico.</p>';
                    return;
                }

                const brierScores = [];
                for (let i = 0; i < calibratedHistory.length; i++) {
                    const subset = calibratedHistory.slice(0, i + 1);
                    const brier = subset.reduce((sum, h) => sum + Math.pow(h.probability - h.actualOutcome, 2), 0) / subset.length;
                    brierScores.push(brier);
                }

                new Chart(canvas, {
                    type: 'line',
                    data: {
                        labels: calibratedHistory.map((_, i) => `#${i + 1}`),
                        datasets: [{
                            label: 'Brier Score',
                            data: brierScores,
                            borderColor: 'rgb(34, 211, 238)',
                            backgroundColor: 'rgba(34, 211, 238, 0.1)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: (context) => `Brier: ${context.parsed.y.toFixed(3)}`
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 0.5,
                                ticks: { color: '#9ca3af' },
                                grid: { color: 'rgba(255,255,255,0.1)' }
                            },
                            x: {
                                ticks: { color: '#9ca3af' },
                                grid: { display: false }
                            }
                        }
                    }
                });
            }, 100);
        }

        // Renderizado
        function render() {
            const app = document.getElementById('app');
            
            let html = `
                <!-- Header -->
                <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-6 mb-4 border border-white/20 shadow-xl">
                    <div class="flex items-center gap-3 mb-2">
                        <svg class="w-8 h-8 text-cyan-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                        </svg>
                        <h1 class="text-2xl font-bold text-white">Predictor Pro AI</h1>
                    </div>
                    <p class="text-gray-300 text-sm">Bayesiano + ML + Sentiment Auto</p>
                    ${state.history.length > 0 ? `
                        <div class="mt-2 text-xs text-cyan-400 flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                            </svg>
                            <span>Historial: ${state.history.length} | Calibradas: ${state.history.filter(h => h.actualOutcome !== undefined).length}</span>
                        </div>
                    ` : ''}
                </div>
            `;

            if (state.isCalculating) {
                html += `
                    <div class="flex flex-col items-center justify-center p-8 bg-white/10 backdrop-blur-lg rounded-2xl border border-white/20">
                        <svg class="w-12 h-12 text-cyan-400 animate-spin mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                        </svg>
                        <p class="text-white text-lg font-semibold">Calculando EV...</p>
                        <p class="text-gray-400 text-sm mt-1">Procesando ${state.eventType} con ML</p>
                    </div>
                `;
            } else if (state.step === 0) {
                html += `
                    <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-6 border border-white/20 shadow-xl">
                        <h2 class="text-xl font-semibold text-white mb-4">Tipo de Evento</h2>
                        
                        <!-- Nuevo: Query para sentiment -->
                        <div class="mb-4">
                            <label class="text-white text-sm font-medium block mb-2">üîç Descripci√≥n del evento (para sentiment auto)</label>
                            <input type="text" placeholder="Ej: Trump wins 2024 election" 
                                class="w-full bg-white/20 border border-white/30 rounded-lg px-4 py-3 text-white placeholder-gray-400 focus:ring-2 focus:ring-cyan-400 outline-none transition"
                                oninput="state.eventQuery = this.value" value="${state.eventQuery}">
                            <p class="text-gray-400 text-xs mt-1">Usaremos esto para analizar sentiment en redes sociales autom√°ticamente</p>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-3">
                            ${Object.keys(eventTypes).map(type => `
                                <button onclick="selectEventType('${type}')" class="bg-gradient-to-r from-cyan-500 to-blue-500 hover:from-cyan-600 hover:to-blue-600 text-white py-4 px-4 rounded-xl font-medium transition-all transform hover:scale-105 shadow-md">
                                    ${type}
                                </button>
                            `).join('')}
                        </div>
                    </div>
                `;
            } else if (state.step >= 1 && state.step <= 5) {
                const q = questions[state.step - 1];
                html += `
                    <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-6 border border-white/20 shadow-xl">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-lg font-semibold text-white">
                                ${['Hist√≥rico', 'Contexto', 'An√°logos', 'Externos', 'Mercado'][state.step - 1]}
                            </h2>
                            <span class="text-cyan-400 font-bold">${state.step}/7</span>
                        </div>
                        
                        ${state.step === 3 ? `
                            <div class="bg-blue-900/20 p-3 rounded-lg border border-blue-700/50 text-blue-200 text-xs mb-4">
                                <strong class="text-white block mb-1">¬øQu√© es un An√°logo?</strong>
                                Compara tu evento con otros similares ya resueltos. La Rareza penaliza si tu evento es √∫nico.
                            </div>
                        ` : ''}
                        
                        <div class="space-y-4">
                            <div>
                                <label class="text-white font-medium block mb-2">${q.q1}</label>
                                <p class="text-gray-400 text-sm mb-2">${q.q1Help}</p>
                                <input type="number" step="0.01" min="0" max="1" placeholder="0.00 - 1.00" 
                                    class="w-full bg-white/20 border border-white/30 rounded-lg px-4 py-3 text-white placeholder-gray-400 focus:ring-2 focus:ring-cyan-400 outline-none transition"
                                    oninput="updateScore('${q.q1Input}', this.value)" value="${state.scores[q.q1Input] || ''}">
                            </div>
                            
                            ${q.q2 ? `
                                <div>
                                    <label class="text-white font-medium block mb-2">${q.q2}</label>
                                    <p class="text-gray-400 text-sm mb-2">${q.q2Help}</p>
                                    <input type="number" step="0.01" min="0" max="1" placeholder="0.00 - 1.00"
                                        class="w-full bg-white/20 border border-white/30 rounded-lg px-4 py-3 text-white placeholder-gray-400 focus:ring-2 focus:ring-cyan-400 outline-none transition"
                                        oninput="updateScore('${q.q2Input}', this.value)" value="${state.scores[q.q2Input] || ''}">
                                </div>
                            ` : ''}
                            
                            <div class="text-yellow-300 text-xs bg-yellow-900/20 p-2 rounded-lg border border-yellow-800/50">
                                üí° <strong>Flexibilidad:</strong> Campos vac√≠os se autoajustan
                            </div>
                        </div>
                        
                        <button onclick="nextStep()" class="w-full bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-600 hover:to-emerald-600 text-white py-3 px-6 rounded-xl font-semibold mt-6 transition-all shadow-lg">
                            Siguiente ‚Üí
                        </button>
                    </div>
                `;
            } else if (state.step === 6) {
                html += `
                    <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-6 border border-white/20 shadow-xl">
                        <h2 class="text-xl font-semibold text-white mb-4 flex items-center gap-2">
                            <svg class="w-6 h-6 text-cyan-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                            </svg>
                            6/7: Datos de Mercado
                        </h2>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="text-white font-medium block mb-2">Polymarket (Principal)</label>
                                <input type="number" step="0.01" min="0" max="1" placeholder="0.65"
                                    class="w-full bg-white/20 border border-white/30 rounded-lg px-4 py-3 text-white focus:ring-2 focus:ring-cyan-400 outline-none transition"
                                    oninput="updateMarket('polymarket', this.value)" value="${state.marketData.polymarket}">
                            </div>
                            <div>
                                <label class="text-white font-medium block mb-2">Kalshi (opcional)</label>
                                <input type="number" step="0.01" min="0" max="1" placeholder="0.68"
                                    class="w-full bg-white/20 border border-white/30 rounded-lg px-4 py-3 text-white focus:ring-2 focus:ring-cyan-400 outline-none transition"
                                    oninput="updateMarket('kalshi', this.value)" value="${state.marketData.kalshi}">
                            </div>
                            <div>
                                <label class="text-white font-medium block mb-2">Metaculus (opcional)</label>
                                <input type="number" step="0.01" min="0" max="1" placeholder="0.70"
                                    class="w-full bg-white/20 border border-white/30 rounded-lg px-4 py-3 text-white focus:ring-2 focus:ring-cyan-400 outline-none transition"
                                    oninput="updateMarket('metaculus', this.value)" value="${state.marketData.metaculus}">
                            </div>
                            <div>
                                <label class="text-white font-medium block mb-2">Volumen USD (Liquidez)</label>
                                <input type="number" placeholder="25000"
                                    class="w-full bg-white/20 border border-white/30 rounded-lg px-4 py-3 text-white focus:ring-2 focus:ring-cyan-400 outline-none transition"
                                    oninput="updateMarket('volume', this.value)" value="${state.marketData.volume}">
                            </div>
                        </div>
                        
                        <button onclick="nextStep()" class="w-full bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-600 hover:to-emerald-600 text-white py-3 px-6 rounded-xl font-semibold mt-6 transition-all shadow-lg">
                            Siguiente ‚Üí
                        </button>
                    </div>
                `;
            } else if (state.step === 7) {
                html += `
                    <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-6 border border-white/20 shadow-xl">
                        <h2 class="text-xl font-semibold text-white mb-4 flex items-center gap-2">
                            <svg class="w-6 h-6 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                            </svg>
                            7/7: Factores Avanzados
                        </h2>
                        
                        <div class="text-yellow-300 text-sm bg-purple-900/20 p-3 rounded-lg border border-purple-800/50 mb-4">
                            Ajustes finos (¬±10%). Usa sentiment autom√°tico si ingresaste una descripci√≥n.
                        </div>
                        
                        <div class="space-y-4">
                            <!-- NUEVO: Sentiment Autom√°tico -->
                            <div>
                                <label class="text-white font-medium block mb-2 flex items-center gap-2">
                                    <svg class="w-5 h-5 text-purple-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                                    </svg>
                                    Sentiment (Redes Sociales)
                                </label>
                                
                                ${state.eventQuery ? `
                                    <div class="grid grid-cols-2 gap-2 mb-3">
                                        <button onclick="openSentimentTool('reddit')" 
                                            class="bg-gradient-to-r from-orange-600 to-red-600 hover:from-orange-700 hover:to-red-700 text-white py-2 px-3 rounded-lg font-semibold transition-all flex items-center justify-center gap-2 text-sm">
                                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                                                <path d="M12 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0zm5.01 4.744c.688 0 1.25.561 1.25 1.249a1.25 1.25 0 0 1-2.498.056l-2.597-.547-.8 3.747c1.824.07 3.48.632 4.674 1.488.308-.309.73-.491 1.207-.491.968 0 1.754.786 1.754 1.754 0 .716-.435 1.333-1.01 1.614a3.111 3.111 0 0 1 .042.52c0 2.694-3.13 4.87-7.004 4.87-3.874 0-7.004-2.176-7.004-4.87 0-.183.015-.366.043-.534A1.748 1.748 0 0 1 4.028 12c0-.968.786-1.754 1.754-1.754.463 0 .898.196 1.207.49 1.207-.883 2.878-1.43 4.744-1.487l.885-4.182a.342.342 0 0 1 .14-.197.35.35 0 0 1 .238-.042l2.906.617a1.214 1.214 0 0 1 1.108-.701zM9.25 12C8.561 12 8 12.562 8 13.25c0 .687.561 1.248 1.25 1.248.687 0 1.248-.561 1.248-1.249 0-.688-.561-1.249-1.249-1.249zm5.5 0c-.687 0-1.248.561-1.248 1.25 0 .687.561 1.248 1.249 1.248.688 0 1.249-.561 1.249-1.249 0-.687-.562-1.249-1.25-1.249zm-5.466 3.99a.327.327 0 0 0-.231.094.33.33 0 0 0 0 .463c.842.842 2.484.913 2.961.913.477 0 2.105-.056 2.961-.913a.361.361 0 0 0 .029-.463.33.33 0 0 0-.464 0c-.547.533-1.684.73-2.512.73-.828 0-1.979-.196-2.512-.73a.326.326 0 0 0-.232-.095z"/>
                                            </svg>
                                            Reddit
                                        </button>
                                        <button onclick="openSentimentTool('twitter')" 
                                            class="bg-gradient-to-r from-blue-500 to-blue-700 hover:from-blue-600 hover:to-blue-800 text-white py-2 px-3 rounded-lg font-semibold transition-all flex items-center justify-center gap-2 text-sm">
                                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                                                <path d="M23.953 4.57a10 10 0 01-2.825.775 4.958 4.958 0 002.163-2.723c-.951.555-2.005.959-3.127 1.184a4.92 4.92 0 00-8.384 4.482C7.69 8.095 4.067 6.13 1.64 3.162a4.822 4.822 0 00-.666 2.475c0 1.71.87 3.213 2.188 4.096a4.904 4.904 0 01-2.228-.616v.06a4.923 4.923 0 003.946 4.827 4.996 4.996 0 01-2.212.085 4.936 4.936 0 004.604 3.417 9.867 9.867 0 01-6.102 2.105c-.39 0-.779-.023-1.17-.067a13.995 13.995 0 007.557 2.209c9.053 0 13.998-7.496 13.998-13.985 0-.21 0-.42-.015-.63A9.935 9.935 0 0024 4.59z"/>
                                            </svg>
                                            Twitter
                                        </button>
                                    </div>
                                    <button onclick="openSentimentTool('google')" 
                                        class="w-full bg-gradient-to-r from-green-600 to-teal-600 hover:from-green-700 hover:to-teal-700 text-white py-2 px-4 rounded-lg font-semibold mb-3 transition-all flex items-center justify-center gap-2 text-sm">
                                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                                            <path d="M12.48 10.92v3.28h7.84c-.24 1.84-.853 3.187-1.787 4.133-1.147 1.147-2.933 2.4-6.053 2.4-4.827 0-8.6-3.893-8.6-8.72s3.773-8.72 8.6-8.72c2.6 0 4.507 1.027 5.907 2.347l2.307-2.307C18.747 1.44 16.133 0 12.48 0 5.867 0 .307 5.387.307 12s5.56 12 12.173 12c3.573 0 6.267-1.173 8.373-3.36 2.16-2.16 2.84-5.213 2.84-7.667 0-.76-.053-1.467-.173-2.053H12.48z"/>
                                        </svg>
                                        Google News
                                    </button>
                                    <div class="bg-blue-900/20 p-3 rounded-lg border border-blue-700/50 text-blue-200 text-xs">
                                        üí° <strong>C√≥mo usar:</strong> Click en el bot√≥n ‚Üí Analiza los posts/tweets ‚Üí Lee el tono general ‚Üí Ingresa tu estimaci√≥n abajo (0.20=Muy negativo, 0.50=Neutral, 0.80=Muy positivo)
                                    </div>
                                ` : `
                                    <div class="bg-orange-900/20 p-3 rounded-lg border border-orange-700/50 text-orange-200 text-xs mb-3">
                                        ‚ö†Ô∏è Ingresa una descripci√≥n del evento en el paso 1 para abrir herramientas de sentiment
                                    </div>
                                `}
                                
                                ${state.sentimentAuto ? `
                                    <div class="bg-green-900/20 p-3 rounded-lg border border-green-700/50 mb-2">
                                        <div class="flex justify-between text-sm mb-1">
                                            <span class="text-green-300 font-semibold">‚úÖ Sentiment detectado</span>
                                            <span class="text-white">${(state.sentimentAuto.score * 100).toFixed(1)}%</span>
                                        </div>
                                        <div class="text-xs text-gray-400">
                                            Confianza: ${(state.sentimentAuto.confidence * 100).toFixed(0)}% | 
                                            ${state.sentimentAuto.sources} posts analizados
                                        </div>
                                    </div>
                                ` : ''}
                                
                                <p class="text-gray-400 text-xs mb-2">0.80+=Muy bullish, 0.50=Neutral, 0.20-=Muy bearish</p>
                                <input type="number" step="0.01" min="0" max="1" placeholder="0.50"
                                    class="w-full bg-white/20 border border-white/30 rounded-lg px-4 py-3 text-white focus:ring-2 focus:ring-cyan-400 outline-none transition"
                                    oninput="updateAdvanced('sentiment', this.value)" value="${state.advancedData.sentiment}">
                            </div>
                            
                            <div>
                                <label class="text-white font-medium block mb-2">Momentum Reciente</label>
                                <p class="text-gray-400 text-xs mb-2">0.80+=Subida fuerte, 0.50=Estable, 0.20-=Bajada fuerte</p>
                                <input type="number" step="0.01" min="0" max="1" placeholder="0.50"
                                    class="w-full bg-white/20 border border-white/30 rounded-lg px-4 py-3 text-white focus:ring-2 focus:ring-cyan-400 outline-none transition"
                                    oninput="updateAdvanced('momentum', this.value)" value="${state.advancedData.momentum}">
                            </div>
                            
                            <div>
                                <label class="text-white font-medium block mb-2">Riesgo de Manipulaci√≥n</label>
                                <p class="text-gray-400 text-xs mb-2">0.00=Ninguno, 0.50=Bajo, 1.00=Alto riesgo</p>
                                <input type="number" step="0.01" min="0" max="1" placeholder="0.50"
                                    class="w-full bg-white/20 border border-white/30 rounded-lg px-4 py-3 text-white focus:ring-2 focus:ring-cyan-400 outline-none transition"
                                    oninput="updateAdvanced('manipulation', this.value)" value="${state.advancedData.manipulation}">
                            </div>
                        </div>
                        
                        <button onclick="calculateProbability()" class="w-full bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 text-white py-4 px-6 rounded-xl font-bold mt-6 transition-all transform hover:scale-[1.02] shadow-2xl">
                            üéØ Calcular EV
                        </button>
                    </div>
                `;
            } else if (state.step === 8 && state.result) {
                if (state.result.error) {
                    html += `
                        <div class="bg-red-800/50 rounded-2xl p-6 border border-red-600 shadow-xl">
                            <h2 class="text-white text-xl font-bold mb-2 flex items-center gap-2">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                Error
                            </h2>
                            <p class="text-red-200">${state.result.message}</p>
                        </div>
                    `;
                } else {
                    const r = state.result;
                    html += `
                        <div class="space-y-4">
                            <!-- NUEVO: Probabilidad con Intervalo de Confianza -->
                            <div class="bg-gradient-to-r from-cyan-500 to-blue-600 rounded-2xl p-6 border border-white/20 shadow-xl">
                                <h2 class="text-white text-sm font-medium mb-2">PROBABILIDAD CALCULADA</h2>
                                <div class="text-5xl font-bold text-white mb-2">
                                    ${(r.probability * 100).toFixed(1)}%
                                </div>
                                <div class="text-cyan-100 text-sm mb-1">
                                    Intervalo: ${(r.lowerBound * 100).toFixed(1)}% - ${(r.upperBound * 100).toFixed(1)}%
                                </div>
                                <div class="text-cyan-200 text-xs">
                                    vs Mercado: ${(r.marketConsensus * 100).toFixed(1)}% | Sentiment: ${r.sentimentUsed}
                                </div>
                            </div>

                            <!-- EV y Recomendaci√≥n -->
                            <div class="rounded-2xl p-6 border border-white/20 shadow-xl ${
                                r.recommendation === 'APOSTAR' ? 'bg-gradient-to-r from-green-600 to-emerald-700' :
                                r.recommendation === 'SKIP' ? 'bg-gradient-to-r from-red-600 to-rose-700' :
                                'bg-gradient-to-r from-gray-600 to-gray-700'
                            }">
                                <div class="flex items-center justify-between mb-4">
                                    <span class="text-white font-bold text-xl">${r.recommendation}</span>
                                    <span class="text-white text-2xl font-bold">
                                        EV: ${(r.ev * 100).toFixed(1)}%
                                    </span>
                                </div>
                                <div class="text-white/90 text-sm">
                                    ${r.recommendation === 'APOSTAR' ? '‚úÖ Valor esperado positivo significativo' : ''}
                                    ${r.recommendation === 'SKIP' ? '‚ùå Valor esperado negativo. Evitar.' : ''}
                                    ${r.recommendation === 'NEUTRAL' ? '‚öñÔ∏è Precio justo. Apostar solo si bajo riesgo.' : ''}
                                </div>
                            </div>

                            <!-- NUEVO: Comparaci√≥n de Mercados -->
                            ${state.marketComparison ? `
                                <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-6 border border-white/20 shadow-xl">
                                    <div class="flex items-center gap-2 mb-3">
                                        <svg class="w-5 h-5 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                        </svg>
                                        <h3 class="text-white font-semibold">Comparaci√≥n de Mercados</h3>
                                    </div>
                                    <div class="space-y-2">
                                        ${state.marketComparison.markets.map(m => `
                                            <div class="flex justify-between items-center">
                                                <span class="text-gray-300 text-sm">${m.name}</span>
                                                <span class="text-white font-medium">${(m.prob * 100).toFixed(1)}%</span>
                                            </div>
                                        `).join('')}
                                        <div class="border-t border-white/20 pt-2 mt-2">
                                            <div class="flex justify-between text-xs">
                                                <span class="text-gray-400">Consenso:</span>
                                                <span class="${state.marketComparison.consensus === 'Alto' ? 'text-green-400' : state.marketComparison.consensus === 'Moderado' ? 'text-yellow-400' : 'text-red-400'} font-semibold">
                                                    ${state.marketComparison.consensus}
                                                </span>
                                            </div>
                                            <div class="flex justify-between text-xs mt-1">
                                                <span class="text-gray-400">Spread:</span>
                                                <span class="text-white">${(state.marketComparison.spread * 100).toFixed(1)}%</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            ` : ''}

                            <!-- Sesgo del Mercado -->
                            <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-6 border border-white/20 shadow-xl">
                                <div class="flex items-center gap-2 mb-2">
                                    <svg class="w-5 h-5 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                    <h3 class="text-white font-semibold">An√°lisis de Sesgo</h3>
                                </div>
                                <div class="text-yellow-300 font-medium mb-1">${r.bias}</div>
                                <div class="text-gray-300 text-sm">${r.biasDetail}</div>
                            </div>

                            <!-- M√©tricas + Gr√°fico Brier -->
                            <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-6 border border-white/20 shadow-xl">
                                <div class="flex items-center gap-2 mb-4">
                                    <svg class="w-5 h-5 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                    </svg>
                                    <h3 class="text-white font-semibold">Detalles del Modelo</h3>
                                </div>
                                <div class="space-y-2 text-sm mb-4">
                                    <div class="flex justify-between">
                                        <span class="text-gray-400">Categor√≠as:</span>
                                        <span class="text-white font-medium">${r.validCategories.length}/5</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-400">Confianza:</span>
                                        <span class="text-white font-medium">${(r.confidenceFactor * 100).toFixed(0)}%</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-400">Brier Score:</span>
                                        <span class="${r.brierScore !== null && r.brierScore < 0.15 ? 'text-green-400' : 'text-yellow-400'} font-medium">
                                            ${r.brierScore !== null ? r.brierScore.toFixed(3) : 'N/A'}
                                        </span>
                                    </div>
                                </div>
                                
                                <!-- NUEVO: Gr√°fico de Brier Score -->
                                <div class="mt-4">
                                    <h4 class="text-white text-sm font-semibold mb-2">Evoluci√≥n de Precisi√≥n</h4>
                                    <div class="h-40 bg-black/20 rounded-lg p-2">
                                        <canvas id="brierChart"></canvas>
                                    </div>
                                </div>
                            </div>

                            <!-- Calibraci√≥n -->
                            <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-4 border border-white/20 shadow-xl">
                                <h3 class="text-white font-semibold mb-3 text-sm">Registrar Resultado Real</h3>
                                <p class="text-gray-400 text-xs mb-2">Mejora tu Brier Score registrando el resultado cuando se resuelva</p>
                                <div class="flex justify-around gap-2">
                                    <button onclick="recordOutcome(${r.timestamp}, 1)" 
                                        class="flex-1 bg-green-700 hover:bg-green-600 text-white py-2 rounded-lg text-sm font-semibold transition-colors">
                                        Ocurri√≥ (1)
                                    </button>
                                    <button onclick="recordOutcome(${r.timestamp}, 0)"
                                        class="flex-1 bg-red-700 hover:bg-red-600 text-white py-2 rounded-lg text-sm font-semibold transition-colors">
                                        No Ocurri√≥ (0)
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }

                html += `
                    <button onclick="resetCalculator()" class="w-full bg-white/20 hover:bg-white/30 text-white py-3 px-6 rounded-xl font-semibold transition-all flex items-center justify-center gap-2 mt-4 shadow-lg">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                        </svg>
                        Nueva Predicci√≥n
                    </button>
                `;
            }

            app.innerHTML = html;
            
            // Renderizar gr√°fico si estamos en resultados
            if (state.step === 8 && state.result && !state.result.error) {
                renderBrierChart();
            }
        }

        // Event handlers globales
        function selectEventType(type) {
            state.eventType = type;
            state.step = 1;
            render();
        }

        function nextStep() {
            state.step++;
            render();
        }

        function updateScore(key, value) {
            state.scores[key] = value;
        }

        function updateMarket(key, value) {
            state.marketData[key] = value;
        }

        function updateAdvanced(key, value) {
            state.advancedData[key] = value;
        }

        // Inicializaci√≥n
        loadHistory().then(() => render());
    </script>
</body>
</html>