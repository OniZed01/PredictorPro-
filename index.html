<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Predictor Pro AI v6.0 - Enhanced</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/eruda"></script>
    <script>eruda.init();</script>
    <style>
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .animate-spin { animation: spin 1s linear infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .animate-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
    </style>
</head>
<body class="bg-gradient-to-br from-indigo-900 via-purple-900 to-pink-900 min-h-screen p-4">
    <div class="max-w-4xl mx-auto">
        <!-- Header -->
        <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-6 mb-4 border border-white/20 shadow-xl">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <svg class="w-8 h-8 text-cyan-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                    </svg>
                    <div>
                        <h1 class="text-2xl font-bold text-white">Predictor Pro AI v6.0</h1>
                        <p class="text-gray-300 text-xs">Enhanced Bayesian Engine + JSON Schema</p>
                    </div>
                </div>
                <div id="costTracker" class="text-right">
                    <div class="text-xs text-gray-400">Costo Sesi√≥n</div>
                    <div class="text-lg font-bold text-green-400">$0.00</div>
                </div>
            </div>
        </div>

        <!-- Stats Dashboard -->
        <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-4 mb-4 border border-white/20 shadow-xl">
            <div class="grid grid-cols-3 gap-3 text-center">
                <div>
                    <div class="text-gray-400 text-xs mb-1">Hoy</div>
                    <div id="todayCount" class="text-white font-bold text-xl">0</div>
                    <div class="text-gray-500 text-xs">de 20 max</div>
                </div>
                <div>
                    <div class="text-gray-400 text-xs mb-1">Cach√© Hits</div>
                    <div id="cacheHits" class="text-green-400 font-bold text-xl">0</div>
                    <div class="text-gray-500 text-xs">$0 ahorrado</div>
                </div>
                <div>
                    <div class="text-gray-400 text-xs mb-1">Total Tokens</div>
                    <div id="totalTokens" class="text-cyan-400 font-bold text-xl">0</div>
                    <div class="text-gray-500 text-xs">este mes</div>
                </div>
            </div>
            <button onclick="clearAllCache()" class="w-full mt-3 bg-red-900/30 hover:bg-red-900/50 text-red-300 text-xs py-2 rounded-lg transition-all">
                üóëÔ∏è Limpiar Cach√©
            </button>
        </div>

        <!-- Configuraci√≥n -->
        <div id="inputSection" class="bg-white/10 backdrop-blur-lg rounded-2xl p-6 mb-4 border border-white/20 shadow-xl">
            <h2 class="text-xl font-semibold text-white mb-4">üéØ Configuraci√≥n</h2>
            
            <div class="space-y-4">
                <div>
                    <label class="text-white font-medium block mb-2">üîë Claude API Key</label>
                    <div class="flex gap-2">
                        <input type="password" id="apiKey" placeholder="sk-ant-api03-..." 
                            class="flex-1 bg-white/20 border border-white/30 rounded-lg px-4 py-3 text-white placeholder-gray-400 focus:ring-2 focus:ring-cyan-400 outline-none">
                        <button onclick="saveApiKey()" class="bg-green-600 hover:bg-green-700 px-4 rounded-lg text-white font-medium">
                            üíæ
                        </button>
                    </div>
                    <p class="text-gray-400 text-xs mt-1">
                        üéÅ $5 gratis en <a href="https://console.anthropic.com" target="_blank" class="text-cyan-400 underline">console.anthropic.com</a>
                    </p>
                </div>

                <div>
                    <label class="text-white font-medium block mb-2">üîó URL del Mercado</label>
                    <input type="text" id="marketUrl" 
                        placeholder="https://polymarket.com/event/nombre-del-mercado"
                        class="w-full bg-white/20 border border-white/30 rounded-lg px-4 py-3 text-white placeholder-gray-400 focus:ring-2 focus:ring-cyan-400 outline-none">
                </div>

                <!-- NUEVA: Configuraci√≥n Avanzada -->
                <details class="bg-white/5 rounded-lg p-4 border border-white/10">
                    <summary class="text-white font-medium cursor-pointer">‚öôÔ∏è Configuraci√≥n Avanzada</summary>
                    <div class="mt-4 space-y-3">
                        <div>
                            <label class="text-white text-sm block mb-2">üìä EV Threshold COMPRA (%)</label>
                            <input type="range" id="evBuy" min="5" max="30" value="15" step="1"
                                class="w-full" oninput="document.getElementById('evBuyVal').textContent = this.value + '%'">
                            <div class="text-cyan-400 text-sm text-right" id="evBuyVal">15%</div>
                        </div>
                        <div>
                            <label class="text-white text-sm block mb-2">üìâ EV Threshold SKIP (%)</label>
                            <input type="range" id="evSkip" min="-30" max="-5" value="-15" step="1"
                                class="w-full" oninput="document.getElementById('evSkipVal').textContent = this.value + '%'">
                            <div class="text-red-400 text-sm text-right" id="evSkipVal">-15%</div>
                        </div>
                        <div>
                            <label class="text-white text-sm block mb-2">üé≤ Prior Bayesiano</label>
                            <select id="priorMode" class="w-full bg-white/20 border border-white/30 rounded-lg px-3 py-2 text-white">
                                <option value="uniform">Uniforme (1/N outcomes)</option>
                                <option value="fixed">Fijo 50% (binario)</option>
                                <option value="market">Basado en mercado</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-white text-sm block mb-2">üìù Contexto LLM (caracteres)</label>
                            <input type="range" id="contextLimit" min="300" max="2000" value="1500" step="100"
                                class="w-full" oninput="document.getElementById('contextVal').textContent = this.value">
                            <div class="text-cyan-400 text-sm text-right" id="contextVal">1500</div>
                        </div>
                    </div>
                </details>

                <div>
                    <label class="text-white font-medium block mb-2">‚öôÔ∏è Modo de An√°lisis</label>
                    <select id="analysisMode" class="w-full bg-white/20 border border-white/30 rounded-lg px-4 py-3 text-white focus:ring-2 focus:ring-cyan-400 outline-none">
                        <option value="full">üî• Completo (todos los outcomes)</option>
                        <option value="smart" selected>‚ú® Inteligente (pre-filtro + batch)</option>
                        <option value="top3">üíé Top 3 (m√°ximo ahorro)</option>
                    </select>
                </div>

                <div class="bg-gradient-to-r from-green-900/30 to-emerald-900/30 border border-green-700/50 rounded-lg p-4">
                    <div class="flex items-start gap-2">
                        <svg class="w-5 h-5 text-green-400 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                        </svg>
                        <div class="text-green-200 text-sm">
                            <strong>v6.0 Mejoras:</strong> Prior adaptativo (1/N), JSON Schema forzado, contexto expandido (1.5k), 
                            thresholds personalizables, scores visibles en resultados.
                        </div>
                    </div>
                </div>
            </div>

            <button onclick="analyzeMarket()" 
                class="w-full bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 text-white py-4 px-6 rounded-xl font-bold mt-6 transition-all transform hover:scale-[1.02] shadow-2xl">
                üöÄ Analizar con Claude Sonnet 4.5
            </button>
        </div>

        <!-- Loading -->
        <div id="loading" class="hidden bg-white/10 backdrop-blur-lg rounded-2xl p-8 mb-4 border border-white/20 shadow-xl">
            <div class="flex flex-col items-center">
                <svg class="w-16 h-16 text-cyan-400 animate-spin mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                </svg>
                <p class="text-white text-xl font-semibold mb-2">Analizando...</p>
                <p id="loadingStatus" class="text-gray-400 text-sm">Iniciando...</p>
                <div class="mt-4 w-full bg-white/20 rounded-full h-2">
                    <div id="progressBar" class="bg-cyan-400 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
            </div>
        </div>

        <!-- Results -->
        <div id="results" class="hidden space-y-4"></div>
    </div>

    <script>
        // ============================================================================
        // CONFIGURACI√ìN
        // ============================================================================
        
        const CONFIG = {
            claudeEndpoint: 'https://api.anthropic.com/v1/messages',
            claudeModel: 'claude-sonnet-4.5-20250929',
            polymarketAPI: 'https://gamma-api.polymarket.com',
            corsProxy: 'https://api.allorigins.win/raw?url=',
            
            pricing: {
                input: 3.00,
                output: 15.00
            },
            
            dailyLimit: 20,
            cacheExpiry: 3600000, // 1 hora
            
            minVolume: 5000,
            minProb: 0.05,
            maxProb: 0.95
        };

        const WEIGHT_PROFILES = {
            crypto: { hist: 0.15, ctx: 0.05, analog: 0.20, ext: 0.25, mkt: 0.10, sent: 0.20, liq: 0.05 },
            earnings: { hist: 0.35, ctx: 0.20, analog: 0.15, ext: 0.10, mkt: 0.10, sent: 0.05, liq: 0.05 },
            politics: { hist: 0.20, ctx: 0.20, analog: 0.15, ext: 0.10, mkt: 0.05, sent: 0.25, liq: 0.05 },
            sports: { hist: 0.30, ctx: 0.15, analog: 0.25, ext: 0.05, mkt: 0.15, sent: 0.05, liq: 0.05 },
            default: { hist: 0.25, ctx: 0.15, analog: 0.20, ext: 0.15, mkt: 0.10, sent: 0.10, liq: 0.05 }
        };

        let sessionCost = 0;
        let sessionTokens = 0;

        // ============================================================================
        // STATS MANAGEMENT
        // ============================================================================

        function loadStats() {
            const today = new Date().toDateString();
            const stats = JSON.parse(localStorage.getItem('app_stats') || '{}');
            
            if (stats.date !== today) {
                stats.date = today;
                stats.count = 0;
                stats.cacheHits = 0;
            }
            
            document.getElementById('todayCount').textContent = stats.count || 0;
            document.getElementById('cacheHits').textContent = stats.cacheHits || 0;
            
            const monthlyTokens = parseInt(localStorage.getItem('monthly_tokens') || '0');
            document.getElementById('totalTokens').textContent = monthlyTokens.toLocaleString();
            
            return stats;
        }

        function updateStats(increment = true, cacheHit = false) {
            const stats = loadStats();
            
            if (increment) stats.count++;
            if (cacheHit) stats.cacheHits++;
            
            localStorage.setItem('app_stats', JSON.stringify(stats));
            loadStats();
        }

        function updateCost(inputTokens, outputTokens) {
            const cost = (inputTokens * CONFIG.pricing.input + outputTokens * CONFIG.pricing.output) / 1000000;
            sessionCost += cost;
            sessionTokens += (inputTokens + outputTokens);
            
            document.getElementById('costTracker').querySelector('.text-green-400').textContent = 
                `$${sessionCost.toFixed(4)}`;
            
            const monthlyTokens = parseInt(localStorage.getItem('monthly_tokens') || '0');
            localStorage.setItem('monthly_tokens', (monthlyTokens + inputTokens + outputTokens).toString());
            loadStats();
        }

        // ============================================================================
        // API KEY & CONFIG
        // ============================================================================

        function loadApiKey() {
            const saved = localStorage.getItem('claude_api_key');
            if (saved) {
                document.getElementById('apiKey').value = saved;
            }
        }

        function saveApiKey() {
            const key = document.getElementById('apiKey').value.trim();
            if (key && key.startsWith('sk-ant-')) {
                localStorage.setItem('claude_api_key', key);
                alert('‚úÖ API Key guardada');
            } else {
                alert('‚ö†Ô∏è Key inv√°lida. Debe empezar con "sk-ant-"');
            }
        }

        window.addEventListener('DOMContentLoaded', () => {
            loadApiKey();
            loadStats();
        });

        // ============================================================================
        // CACHE SYSTEM
        // ============================================================================

        function getCachedAnalysis(marketUrl) {
            try {
                const cacheKey = `cache_${btoa(marketUrl).substring(0, 50)}`;
                const cached = localStorage.getItem(cacheKey);
                
                if (cached) {
                    const data = JSON.parse(cached);
                    
                    // Validar que tenga todo lo necesario
                    if (!data.results || !data.marketData || !data.config || !data.weights) {
                        console.warn('‚ö†Ô∏è Cach√© incompleto, eliminando');
                        localStorage.removeItem(cacheKey);
                        return null;
                    }
                    
                    // Validar expiraci√≥n
                    if (Date.now() - data.timestamp < CONFIG.cacheExpiry) {
                        console.log('‚úÖ Cache HIT v√°lido');
                        updateStats(false, true);
                        return data;
                    } else {
                        console.log('üïê Cach√© expirado, eliminando');
                        localStorage.removeItem(cacheKey);
                    }
                }
                
                return null;
            } catch (error) {
                console.error('‚ùå Error leyendo cach√©:', error);
                return null;
            }
        }

        function setCachedAnalysis(marketUrl, data) {
            const cacheKey = `cache_${btoa(marketUrl).substring(0, 50)}`;
            localStorage.setItem(cacheKey, JSON.stringify({
                ...data,
                timestamp: Date.now()
            }));
        }

        // ============================================================================
        // POLYMARKET EXTRACTION
        // ============================================================================

        async function extractMarketData(marketUrl) {
            try {
                const slugMatch = marketUrl.match(/event\/([^?]+)/);
                if (!slugMatch) throw new Error('URL inv√°lida');
                
                const slug = slugMatch[1];
                const apiUrl = `${CONFIG.polymarketAPI}/events?slug=${slug}`;
                const proxiedUrl = `${CONFIG.corsProxy}${encodeURIComponent(apiUrl)}`;
                
                console.log('üîç Fetching:', proxiedUrl);
                const response = await fetch(proxiedUrl);
                
                if (!response.ok) throw new Error(`Error ${response.status}`);

                const events = await response.json();
                console.log('‚úÖ Data received:', events);
                
                if (!events || events.length === 0) throw new Error('Mercado no encontrado');

                const event = events[0];
                
                if (!event.markets || event.markets.length === 0) {
                    throw new Error('Sin mercados disponibles');
                }

                let category = 'default';
                const title = event.title.toLowerCase();
                if (title.includes('bitcoin') || title.includes('btc') || title.includes('eth')) {
                    category = 'crypto';
                } else if (title.includes('earning') || title.includes('mentions')) {
                    category = 'earnings';
                } else if (title.includes('election') || title.includes('trump') || title.includes('harris')) {
                    category = 'politics';
                } else if (title.includes('super bowl') || title.includes('nba')) {
                    category = 'sports';
                }

                const outcomes = event.markets.map(market => ({
                    name: market.question || market.groupItemTitle || 'Yes',
                    prob: parseFloat(market.outcomePrices?.[0]) || 0.5,
                    volume_usd: parseFloat(market.volume) || 0,
                    liquidity: parseFloat(market.liquidity) || 0
                }));

                const contextLimit = parseInt(document.getElementById('contextLimit')?.value || 1500);
                const fullContext = event.description || event.title;

                return {
                    title: event.title,
                    context: fullContext.substring(0, contextLimit),
                    category: category,
                    outcomes: outcomes,
                    totalVolume: outcomes.reduce((sum, o) => sum + o.volume_usd, 0),
                    outcomeCount: outcomes.length
                };

            } catch (error) {
                console.error('‚ùå Error:', error);
                throw error;
            }
        }

        // ============================================================================
        // CLAUDE API - ENHANCED WITH JSON SCHEMA
        // ============================================================================

        async function getClaudeScoresBatch(outcomes, marketContext, category, apiKey) {
            const outcomesList = outcomes.map((o, i) => 
                `${i+1}. "${o.name}" (Market: ${(o.prob*100).toFixed(1)}%, Volume: $${(o.volume_usd/1000).toFixed(0)}k)`
            ).join('\n');
            
            // JSON Schema para forzar formato correcto
            const jsonSchema = {
                type: "array",
                items: {
                    type: "object",
                    properties: {
                        hist: { type: "number", minimum: 0, maximum: 1 },
                        ctx: { type: "number", minimum: 0, maximum: 1 },
                        analog: { type: "number", minimum: 0, maximum: 1 },
                        ext: { type: "number", minimum: 0, maximum: 1 },
                        sent: { type: "number", minimum: 0, maximum: 1 }
                    },
                    required: ["hist", "ctx", "analog", "ext", "sent"]
                }
            };
            
            const prompt = `You are a contrarian prediction market analyst. Your job is to find market inefficiencies.

MARKET CONTEXT:
${marketContext}

CATEGORY: ${category.toUpperCase()}

OUTCOMES TO ANALYZE:
${outcomesList}

SCORING INSTRUCTIONS:
For EACH outcome, provide scores from 0.0 to 1.0 for these factors:

1. hist (Historical): How often has this happened historically? (0.2=rare, 0.5=uncertain, 0.8=common)
2. ctx (Catalysts): Current news/events favoring this outcome (0.2=negative, 0.5=neutral, 0.8=strong positive)
3. analog (Analogous): Frequency in similar past situations (0.2=uncommon, 0.5=mixed, 0.8=typical)
4. ext (External): Macro factors, regulations, geopolitics (0.2=headwinds, 0.5=neutral, 0.8=tailwinds)
5. sent (Sentiment): Social media, news, expert opinion (0.2=bearish, 0.5=mixed, 0.8=bullish)

CRITICAL RULES:
- Be OPINIONATED. Use the full 0.2-0.8 range. Don't default to 0.5 unless truly uncertain.
- Look for MISPRICING. If market is at 50% but fundamentals suggest 70%, score accordingly.
- Consider VOLUME. Low volume = more potential mispricing.
- Think CONTRARIAN. The crowd is often wrong.

OUTPUT:
Return a JSON array with exactly ${outcomes.length} objects matching this schema:
${JSON.stringify(jsonSchema, null, 2)}

Example:
[
  {"hist": 0.65, "ctx": 0.72, "analog": 0.58, "ext": 0.45, "sent": 0.80},
  {"hist": 0.35, "ctx": 0.28, "analog": 0.42, "ext": 0.55, "sent": 0.20}
]

RESPOND WITH ONLY THE JSON ARRAY. NO EXPLANATIONS.`;

            try {
                console.log('ü§ñ Calling Claude API...');
                console.log('üìù Full prompt:', prompt);
                
                const response = await fetch(CONFIG.claudeEndpoint, {
                    method: 'POST',
                    headers: {
                        'x-api-key': apiKey,
                        'anthropic-version': '2023-06-01',
                        'content-type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: CONFIG.claudeModel,
                        max_tokens: 2000,
                        temperature: 0.3,
                        messages: [{
                            role: 'user',
                            content: prompt
                        }]
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('‚ùå API Error Response:', errorText);
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }

                const data = await response.json();
                console.log('‚úÖ Full API Response:', JSON.stringify(data, null, 2));
                
                if (!data.content || !Array.isArray(data.content) || data.content.length === 0) {
                    throw new Error('Invalid response structure');
                }
                
                if (!data.content[0].text) {
                    throw new Error('No text in response');
                }
                
                updateCost(data.usage.input_tokens, data.usage.output_tokens);
                
                let content = data.content[0].text.trim();
                console.log('üìä Raw response text:', content);
                
                // Limpieza agresiva
                content = content.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
                
                // Extraer solo el array JSON
                const jsonMatch = content.match(/\[[\s\S]*\]/);
                if (jsonMatch) {
                    content = jsonMatch[0];
                }
                
                console.log('üîß Cleaned JSON:', content);

                const scoresArray = JSON.parse(content);
                console.log('‚úÖ Parsed array:', scoresArray);
                
                if (!Array.isArray(scoresArray)) {
                    throw new Error('Response is not an array');
                }
                
                if (scoresArray.length !== outcomes.length) {
                    console.warn(`‚ö†Ô∏è Expected ${outcomes.length} scores, got ${scoresArray.length}`);
                }
                
                // Normalizar y validar
                return scoresArray.map((scores, idx) => {
                    const normalized = {};
                    ['hist', 'ctx', 'analog', 'ext', 'sent'].forEach(cat => {
                        if (!(cat in scores)) {
                            console.warn(`Missing ${cat} in outcome ${idx}, using 0.50`);
                            normalized[cat] = 0.50;
                        } else {
                            normalized[cat] = Math.max(0.0, Math.min(1.0, parseFloat(scores[cat]) || 0.50));
                        }
                    });
                    console.log(`Outcome ${idx+1} normalized scores:`, normalized);
                    return normalized;
                });

            } catch (error) {
                console.error('üí• CRITICAL ERROR:', error);
                console.error('Stack:', error.stack);
                
                // Fallback neutral
                console.warn('‚ö†Ô∏è Using neutral fallback');
                return outcomes.map(() => ({
                    hist: 0.50, ctx: 0.50, analog: 0.50, ext: 0.50, sent: 0.50
                }));
            }
        }

        // ============================================================================
        // ENHANCED BAYESIAN CALCULATION
        // ============================================================================

        function calculateBayesian(scores, weights, marketProb, liquidityScore, prior) {
            scores.mkt = marketProb;
            scores.liq = liquidityScore;

            const weightedSum = Object.keys(weights).reduce((sum, cat) => 
                sum + weights[cat] * (scores[cat] || 0.50), 0);

            // Prior adaptativo o fijo
            const posterior = (weightedSum + prior) / 2;

            const scoreValues = Object.values(scores);
            const variance = scoreValues.reduce((sum, s) => 
                sum + Math.pow(s - weightedSum, 2), 0) / scoreValues.length;
            const confidence = 1.0 - Math.min(variance, 0.3);

            let finalProb = posterior * confidence + prior * (1 - confidence);
            finalProb = Math.max(0.01, Math.min(0.99, finalProb));

            return { 
                probability: finalProb, 
                confidence, 
                posterior,
                weightedSum,
                rawScores: {...scores}
            };
        }

        // ============================================================================
        // MAIN ANALYSIS
        // ============================================================================

        async function analyzeMarket() {
            const apiKey = document.getElementById('apiKey').value.trim();
            const marketUrl = document.getElementById('marketUrl').value.trim();
            const mode = document.getElementById('analysisMode').value;
            
            // Thresholds personalizables
            const evBuy = parseFloat(document.getElementById('evBuy').value) / 100;
            const evSkip = parseFloat(document.getElementById('evSkip').value) / 100;
            const priorMode = document.getElementById('priorMode').value;

            if (!apiKey || !apiKey.startsWith('sk-ant-')) {
                alert('‚ö†Ô∏è Ingresa una API Key v√°lida');
                return;
            }

            if (!marketUrl) {
                alert('‚ö†Ô∏è Ingresa la URL del mercado');
                return;
            }

            const stats = loadStats();
            if (stats.count >= CONFIG.dailyLimit) {
                alert(`‚ö†Ô∏è L√≠mite diario alcanzado (${CONFIG.dailyLimit})`);
                return;
            }

            // Check cache
            const cached = getCachedAnalysis(marketUrl);
            if (cached && cached.marketData && cached.results && cached.config) {
                console.log('‚úÖ Usando cach√© v√°lido:', cached);
                displayResults(cached.results, cached.marketData, cached.weights, cached.category, cached.config);
                return;
            } else if (cached) {
                console.warn('‚ö†Ô∏è Cach√© corrupto, analizando de nuevo');
                localStorage.removeItem(`cache_${btoa(marketUrl).substring(0, 50)}`);
            }

            document.getElementById('inputSection').classList.add('hidden');
            document.getElementById('results').classList.add('hidden');
            document.getElementById('loading').classList.remove('hidden');
            updateProgress(10, 'üì° Extrayendo datos...');

            let marketData;
            try {
                marketData = await extractMarketData(marketUrl);
                updateProgress(30, `‚úÖ ${marketData.outcomes.length} outcomes`);
            } catch (error) {
                showError(`Error: ${error.message}`);
                return;
            }

            // Prior adaptativo
            let prior = 0.50;
            if (priorMode === 'uniform') {
                prior = 1.0 / marketData.outcomeCount;
                console.log(`üìä Prior uniforme: ${prior.toFixed(3)} (1/${marketData.outcomeCount})`);
            } else if (priorMode === 'market') {
                prior = marketData.outcomes.reduce((sum, o) => sum + o.prob, 0) / marketData.outcomes.length;
                console.log(`üìä Prior basado en mercado: ${prior.toFixed(3)}`);
            }

            // Pre-filter
            let outcomesToAnalyze = marketData.outcomes;
            
            if (mode === 'smart') {
                outcomesToAnalyze = marketData.outcomes.filter(o => 
                    o.volume_usd > CONFIG.minVolume && 
                    o.prob > CONFIG.minProb && 
                    o.prob < CONFIG.maxProb
                );
                if (outcomesToAnalyze.length === 0) outcomesToAnalyze = marketData.outcomes;
            } else if (mode === 'top3') {
                outcomesToAnalyze = marketData.outcomes
                    .sort((a, b) => b.volume_usd - a.volume_usd)
                    .slice(0, 3);
            }

            updateProgress(40, `üß† Analizando ${outcomesToAnalyze.length} outcomes...`);

            const weights = WEIGHT_PROFILES[marketData.category] || WEIGHT_PROFILES.default;
            
            // Batch API call
            const scoresArray = await getClaudeScoresBatch(
                outcomesToAnalyze,
                marketData.context,
                marketData.category,
                apiKey
            );

            updateProgress(70, 'üî¢ Calculando probabilidades...');

            const results = outcomesToAnalyze.map((outcome, i) => {
                const liquidityScore = Math.min(0.95, 0.5 + (outcome.liquidity / marketData.totalVolume) * 0.45);
                const bayesianResult = calculateBayesian(scoresArray[i], weights, outcome.prob, liquidityScore, prior);
                const ev = bayesianResult.probability - outcome.prob;

                let verdict = '‚öñÔ∏è NEUTRAL';
                if (ev > evBuy) verdict = 'üî• COMPRA';
                else if (ev < evSkip) verdict = 'üö® SKIP';

                let bias = 'Neutral';
                const diff = bayesianResult.probability - outcome.prob;
                if (Math.abs(diff) < 0.05) bias = 'Neutral';
                else if (diff > 0.15) bias = 'Subestimado';
                else if (diff < -0.15) bias = 'Sobreestimado';
                else if (diff > 0) bias = 'Leve subestimaci√≥n';
                else bias = 'Leve sobreestimaci√≥n';

                return {
                    name: outcome.name,
                    marketProb: outcome.prob,
                    ourProb: bayesianResult.probability,
                    ev: ev,
                    bias: bias,
                    verdict: verdict,
                    confidence: bayesianResult.confidence,
                    volume: outcome.volume_usd,
                    rawScores: bayesianResult.rawScores,
                    posterior: bayesianResult.posterior,
                    weightedSum: bayesianResult.weightedSum
                };
            });

            results.sort((a, b) => b.ev - a.ev);

            const analysisConfig = {
                evBuy: evBuy,
                evSkip: evSkip,
                prior: prior,
                priorMode: priorMode,
                weights: weights
            };

            // Cache results
            setCachedAnalysis(marketUrl, {
                results: results,
                marketData: marketData,
                weights: weights,
                category: marketData.category,
                config: analysisConfig
            });

            updateStats(true, false);
            updateProgress(100, '‚ú® Completado');
            await new Promise(r => setTimeout(r, 500));
            displayResults(results, marketData, weights, marketData.category, analysisConfig);
        }

        // ============================================================================
        // UI HELPERS
        // ============================================================================

        function updateProgress(percent, status) {
            document.getElementById('progressBar').style.width = `${percent}%`;
            document.getElementById('loadingStatus').textContent = status;
        }

        function showError(message) {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('inputSection').classList.remove('hidden');
            
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = `
                <div class="bg-red-900/40 border border-red-700/50 rounded-2xl p-6">
                    <h3 class="text-xl font-bold text-red-400 mb-3">‚ùå Error</h3>
                    <p class="text-white mb-4">${message}</p>
                    <button onclick="resetAnalysis()" 
                        class="bg-white/20 hover:bg-white/30 text-white py-2 px-4 rounded-lg">
                        Reintentar
                    </button>
                </div>
            `;
            resultsDiv.classList.remove('hidden');
        }

        // ============================================================================
        // ENHANCED DISPLAY RESULTS
        // ============================================================================

        function displayResults(results, marketData, weights, category, config) {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '';

            let html = `
                <div class="bg-gradient-to-r from-cyan-500 to-blue-600 rounded-2xl p-6 border border-white/20 shadow-xl">
                    <h2 class="text-2xl font-bold text-white mb-3">üìä ${marketData.title}</h2>
                    <div class="grid grid-cols-2 gap-3 text-sm">
                        <div class="bg-white/20 rounded-lg p-3">
                            <div class="text-cyan-100 mb-1">Categor√≠a</div>
                            <div class="text-white font-semibold">${category.toUpperCase()}</div>
                        </div>
                        <div class="bg-white/20 rounded-lg p-3">
                            <div class="text-cyan-100 mb-1">Volumen</div>
                            <div class="text-white font-semibold">${(marketData.totalVolume/1000).toFixed(0)}k</div>
                        </div>
                        <div class="bg-white/20 rounded-lg p-3">
                            <div class="text-cyan-100 mb-1">Prior</div>
                            <div class="text-white font-semibold">${(config.prior * 100).toFixed(1)}% (${config.priorMode})</div>
                        </div>
                        <div class="bg-white/20 rounded-lg p-3">
                            <div class="text-cyan-100 mb-1">Thresholds</div>
                            <div class="text-white font-semibold text-xs">+${(config.evBuy*100).toFixed(0)}% / ${(config.evSkip*100).toFixed(0)}%</div>
                        </div>
                    </div>
                </div>
            `;

            const buys = results.filter(r => r.verdict === 'üî• COMPRA');
            if (buys.length > 0) {
                html += `
                    <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-6 border border-white/20 shadow-xl">
                        <h3 class="text-xl font-bold text-white mb-4">üî• TOP OPORTUNIDADES (${buys.length})</h3>
                        <div class="space-y-3">
                `;

                for (const r of buys.slice(0, 5)) {
                    html += `
                        <div class="bg-gradient-to-r from-green-900/40 to-emerald-900/40 border border-green-700/50 rounded-lg p-4">
                            <div class="flex justify-between items-start mb-3">
                                <span class="text-white font-semibold text-lg">${r.name}</span>
                                <span class="text-green-400 font-bold text-2xl">+${(r.ev*100).toFixed(1)}%</span>
                            </div>
                            <div class="grid grid-cols-3 gap-3 text-sm mb-3">
                                <div>
                                    <div class="text-gray-400">Mercado</div>
                                    <div class="text-white font-medium">${(r.marketProb*100).toFixed(1)}%</div>
                                </div>
                                <div>
                                    <div class="text-gray-400">Nuestra</div>
                                    <div class="text-white font-medium">${(r.ourProb*100).toFixed(1)}%</div>
                                </div>
                                <div>
                                    <div class="text-gray-400">Confianza</div>
                                    <div class="text-white font-medium">${(r.confidence*100).toFixed(0)}%</div>
                                </div>
                            </div>
                            <details class="text-xs">
                                <summary class="text-yellow-300 cursor-pointer mb-2">üìä Ver scores detallados</summary>
                                <div class="bg-black/30 rounded p-3 space-y-1 text-gray-300">
                                    <div class="flex justify-between">
                                        <span>hist (hist√≥rico):</span>
                                        <span class="text-white">${(r.rawScores.hist*100).toFixed(0)}%</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>ctx (catalizadores):</span>
                                        <span class="text-white">${(r.rawScores.ctx*100).toFixed(0)}%</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>analog (an√°logos):</span>
                                        <span class="text-white">${(r.rawScores.analog*100).toFixed(0)}%</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>ext (externos):</span>
                                        <span class="text-white">${(r.rawScores.ext*100).toFixed(0)}%</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>sent (sentiment):</span>
                                        <span class="text-white">${(r.rawScores.sent*100).toFixed(0)}%</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>mkt (mercado):</span>
                                        <span class="text-white">${(r.rawScores.mkt*100).toFixed(0)}%</span>
                                    </div>
                                    <div class="flex justify-between border-t border-white/20 pt-1 mt-1">
                                        <span class="font-bold">Weighted Sum:</span>
                                        <span class="text-cyan-400 font-bold">${(r.weightedSum*100).toFixed(1)}%</span>
                                    </div>
                                </div>
                            </details>
                        </div>
                    `;
                }

                html += '</div></div>';
            }

            html += `
                <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-6 border border-white/20 shadow-xl">
                    <h3 class="text-xl font-bold text-white mb-4">üìã An√°lisis Completo</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead>
                                <tr class="border-b border-white/20">
                                    <th class="text-left text-gray-300 py-2">Outcome</th>
                                    <th class="text-right text-gray-300 py-2">Market</th>
                                    <th class="text-right text-gray-300 py-2">Nuestra</th>
                                    <th class="text-right text-gray-300 py-2">EV</th>
                                    <th class="text-center text-gray-300 py-2">Acci√≥n</th>
                                </tr>
                            </thead>
                            <tbody>
            `;

            for (const r of results) {
                const evColor = r.ev > 0 ? 'text-green-400' : (r.ev < 0 ? 'text-red-400' : 'text-gray-400');
                html += `
                    <tr class="border-b border-white/10 hover:bg-white/5">
                        <td class="py-3 text-white">${r.name.substring(0, 40)}</td>
                        <td class="text-right text-gray-300">${(r.marketProb*100).toFixed(1)}%</td>
                        <td class="text-right text-white font-medium">${(r.ourProb*100).toFixed(1)}%</td>
                        <td class="text-right ${evColor} font-bold">${r.ev > 0 ? '+' : ''}${(r.ev*100).toFixed(1)}%</td>
                        <td class="text-center text-xs">${r.verdict}</td>
                    </tr>
                `;
            }

            html += `
                            </tbody>
                        </table>
                    </div>
                </div>
            `;

            if (buys.length > 0) {
                const totalEV = buys.reduce((sum, r) => sum + r.ev, 0);
                html += `
                    <div class="bg-gradient-to-r from-purple-900/50 to-pink-900/50 rounded-2xl p-6 border border-white/20 shadow-xl">
                        <h3 class="text-xl font-bold text-white mb-3">üí∞ Portfolio Sugerido</h3>
                        <div class="bg-green-900/30 border border-green-700/50 rounded-lg p-4 mb-4">
                            <div class="text-green-400 font-bold text-3xl mb-1">
                                EV Total: +${(totalEV*100).toFixed(1)}%
                            </div>
                            <div class="text-gray-300 text-sm">
                                Distribuir equitativamente en top ${Math.min(5, buys.length)}
                            </div>
                        </div>
                        <div class="space-y-2">
                `;

                const topBuys = buys.slice(0, 5);
                const weight = 100 / topBuys.length;

                for (const r of topBuys) {
                    html += `
                        <div class="flex justify-between items-center bg-white/5 rounded-lg p-3">
                            <span class="text-white">${r.name.substring(0, 45)}</span>
                            <span class="text-cyan-400 font-bold">${weight.toFixed(0)}%</span>
                        </div>
                    `;
                }

                html += '</div></div>';
            }

            html += `
                <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-6 border border-white/20 shadow-xl">
                    <h3 class="text-xl font-bold text-white mb-3">üß† Metodolog√≠a v6.0</h3>
                    <div class="space-y-2 text-sm text-gray-300">
                        <div class="flex justify-between">
                            <span>Modelo:</span>
                            <span class="text-white">Claude Sonnet 4.5</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Prior bayesiano:</span>
                            <span class="text-white">${(config.prior*100).toFixed(1)}% (${config.priorMode})</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Perfil de pesos:</span>
                            <span class="text-white">${category.toUpperCase()}</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Costo an√°lisis:</span>
                            <span class="text-green-400">${sessionCost.toFixed(4)}</span>
                        </div>
                    </div>
                    <details class="mt-4 pt-3 border-t border-white/20">
                        <summary class="text-cyan-400 cursor-pointer text-sm font-medium mb-2">Ver pesos detallados</summary>
                        <div class="grid grid-cols-2 gap-2 text-xs text-gray-400">
                            ${Object.entries(weights).map(([k, v]) => `
                                <div class="flex justify-between bg-white/5 rounded px-2 py-1">
                                    <span>${k}:</span>
                                    <span class="text-white">${(v*100).toFixed(0)}%</span>
                                </div>
                            `).join('')}
                        </div>
                    </details>
                    <div class="mt-3 pt-3 border-t border-white/20">
                        <div class="text-xs text-gray-400">
                            <strong class="text-white">v6.0 Mejoras:</strong> Prior adaptativo (1/N outcomes), 
                            JSON Schema enforcement, contexto expandido (${marketData.context.length} chars), 
                            thresholds personalizables, scores visibles por outcome.
                        </div>
                    </div>
                </div>
            `;

            html += `
                <button onclick="resetAnalysis()" 
                    class="w-full bg-white/20 hover:bg-white/30 text-white py-3 px-6 rounded-xl font-semibold transition-all flex items-center justify-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                    Analizar Otro Mercado
                </button>
            `;

            resultsDiv.innerHTML = html;
            document.getElementById('loading').classList.add('hidden');
            resultsDiv.classList.remove('hidden');
        }

        function resetAnalysis() {
            document.getElementById('inputSection').classList.remove('hidden');
            document.getElementById('results').classList.add('hidden');
        }
    </script>
</body>
</html>