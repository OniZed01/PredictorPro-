<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Predictor Pro AI v6.2 - Enhanced Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/eruda"></script>
    <script>eruda.init();</script>
    <style>
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .animate-spin { animation: spin 1s linear infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .animate-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        
        /* Light Theme */
        .theme-light {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .theme-light .card {
            background: rgba(255, 255, 255, 0.95);
            border-color: rgba(102, 126, 234, 0.3);
            color: #1a202c;
        }
        .theme-light .text-primary { color: #1a202c; }
        .theme-light .text-secondary { color: #4a5568; }
        .theme-light .text-accent { color: #5a67d8; }
        .theme-light .bg-card { background: rgba(255, 255, 255, 0.95); }
        .theme-light .border-card { border-color: rgba(102, 126, 234, 0.2); }
        
        /* Dark Theme */
        .theme-dark {
            background: linear-gradient(135deg, #1a202c 0%, #2d3748 50%, #1a202c 100%);
        }
        .theme-dark .card {
            background: rgba(45, 55, 72, 0.95);
            border-color: rgba(99, 179, 237, 0.3);
            color: #e2e8f0;
        }
        .theme-dark .text-primary { color: #e2e8f0; }
        .theme-dark .text-secondary { color: #a0aec0; }
        .theme-dark .text-accent { color: #63b3ed; }
        .theme-dark .bg-card { background: rgba(45, 55, 72, 0.95); }
        .theme-dark .border-card { border-color: rgba(99, 179, 237, 0.2); }
    </style>
</head>
<body class="theme-dark min-h-screen p-4 transition-colors duration-300">
    <div class="max-w-4xl mx-auto">
        <!-- Header -->
        <div class="card backdrop-blur-lg rounded-2xl p-6 mb-4 border shadow-xl">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <svg class="w-8 h-8 text-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                    </svg>
                    <div>
                        <h1 class="text-2xl font-bold text-primary">Predictor Pro AI v6.2</h1>
                        <p class="text-secondary text-xs">Enhanced Bayesian + Liquidity Fix</p>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <button onclick="toggleTheme()" class="p-2 rounded-lg hover:bg-white/10 transition-all" title="Toggle Theme">
                        <svg id="themeIcon" class="w-6 h-6 text-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>
                        </svg>
                    </button>
                    <div id="costTracker" class="text-right">
                        <div class="text-xs text-secondary">Costo Sesi√≥n</div>
                        <div class="text-lg font-bold text-green-500">$0.00</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Stats Dashboard -->
        <div class="card backdrop-blur-lg rounded-2xl p-4 mb-4 border shadow-xl">
            <div class="grid grid-cols-3 gap-3 text-center">
                <div>
                    <div class="text-secondary text-xs mb-1">Hoy</div>
                    <div id="todayCount" class="text-primary font-bold text-xl">0</div>
                    <div class="text-secondary text-xs">de 20 max</div>
                </div>
                <div>
                    <div class="text-secondary text-xs mb-1">Cach√© Hits</div>
                    <div id="cacheHits" class="text-green-500 font-bold text-xl">0</div>
                    <div class="text-secondary text-xs">$0 ahorrado</div>
                </div>
                <div>
                    <div class="text-secondary text-xs mb-1">Total Tokens</div>
                    <div id="totalTokens" class="text-accent font-bold text-xl">0</div>
                    <div class="text-secondary text-xs">este mes</div>
                </div>
            </div>
            <button onclick="clearAllCache()" class="w-full mt-3 bg-red-900/30 hover:bg-red-900/50 text-red-400 text-xs py-2 rounded-lg transition-all">
                üóëÔ∏è Limpiar Cach√©
            </button>
        </div>

        <!-- Configuraci√≥n -->
        <div id="inputSection" class="card backdrop-blur-lg rounded-2xl p-6 mb-4 border shadow-xl">
            <h2 class="text-xl font-semibold text-primary mb-4">üéØ Configuraci√≥n</h2>
            
            <div class="space-y-4">
                <div>
                    <label class="text-primary font-medium block mb-2">üîë Claude API Key</label>
                    <div class="flex gap-2">
                        <input type="password" id="apiKey" placeholder="sk-ant-api03-..." 
                            class="flex-1 bg-white/10 border border-card rounded-lg px-4 py-3 text-primary placeholder-secondary focus:ring-2 focus:ring-accent outline-none">
                        <button onclick="saveApiKey()" class="bg-green-600 hover:bg-green-700 px-4 rounded-lg text-white font-medium">
                            üíæ
                        </button>
                    </div>
                    <p class="text-secondary text-xs mt-1">
                        üéÅ $5 gratis en <a href="https://console.anthropic.com" target="_blank" class="text-accent underline">console.anthropic.com</a>
                    </p>
                </div>

                <div>
                    <label class="text-primary font-medium block mb-2">üîó URL del Mercado</label>
                    <input type="text" id="marketUrl" 
                        placeholder="https://polymarket.com/event/nombre-del-mercado"
                        class="w-full bg-white/10 border border-card rounded-lg px-4 py-3 text-primary placeholder-secondary focus:ring-2 focus:ring-accent outline-none">
                </div>

                <!-- Sentiment Override -->
                <div class="bg-blue-900/20 border border-blue-500/30 rounded-lg p-4">
                    <label class="text-primary font-medium block mb-2">
                        üê¶ Sentiment Override (Opcional)
                    </label>
                    <div class="flex gap-2 mb-2">
                        <input type="range" id="sentimentOverride" min="0" max="100" value="50" step="5"
                            class="flex-1" oninput="updateSentimentDisplay()">
                        <span id="sentimentValue" class="text-primary font-bold min-w-[60px] text-right">50%</span>
                    </div>
                    <p class="text-accent text-xs mb-2">
                        Si monitoreaste Twitter/Telegram manualmente, ajusta el sentiment aqu√≠. 
                        <strong>0% = muy bearish</strong>, <strong>50% = neutral</strong>, <strong>100% = muy bullish</strong>
                    </p>
                    <label class="flex items-center gap-2 text-sm text-primary cursor-pointer">
                        <input type="checkbox" id="useSentimentOverride" 
                            class="w-4 h-4 rounded bg-white/20 border-card">
                        Usar mi sentiment (anula an√°lisis de Claude)
                    </label>
                </div>

                <!-- Configuraci√≥n Avanzada -->
                <details class="bg-white/5 rounded-lg p-4 border border-card">
                    <summary class="text-primary font-medium cursor-pointer">‚öôÔ∏è Configuraci√≥n Avanzada</summary>
                    <div class="mt-4 space-y-3">
                        <div class="bg-yellow-900/20 border border-yellow-500/30 rounded-lg p-3 mb-3">
                            <div class="text-yellow-400 text-xs font-medium mb-2">üìä Thresholds Adaptativos por Categor√≠a</div>
                            <div class="grid grid-cols-2 gap-2 text-xs">
                                <div class="bg-black/30 rounded p-2">
                                    <div class="text-secondary">Crypto</div>
                                    <div class="text-primary">+20% / -20%</div>
                                </div>
                                <div class="bg-black/30 rounded p-2">
                                    <div class="text-secondary">Earnings</div>
                                    <div class="text-primary">+12% / -12%</div>
                                </div>
                                <div class="bg-black/30 rounded p-2">
                                    <div class="text-secondary">Politics</div>
                                    <div class="text-primary">+10% / -10%</div>
                                </div>
                                <div class="bg-black/30 rounded p-2">
                                    <div class="text-secondary">Sports</div>
                                    <div class="text-primary">+15% / -15%</div>
                                </div>
                            </div>
                            <label class="flex items-center gap-2 text-xs text-primary mt-2 cursor-pointer">
                                <input type="checkbox" id="useAdaptiveThresholds" checked
                                    class="w-4 h-4 rounded bg-white/20 border-card">
                                Usar thresholds adaptativos (recomendado)
                            </label>
                        </div>
                        
                        <div>
                            <label class="text-primary text-sm block mb-2">üìä EV Threshold COMPRA (manual %)</label>
                            <input type="range" id="evBuy" min="5" max="30" value="15" step="1"
                                class="w-full" oninput="document.getElementById('evBuyVal').textContent = this.value + '%'">
                            <div class="text-accent text-sm text-right" id="evBuyVal">15%</div>
                        </div>
                        <div>
                            <label class="text-primary text-sm block mb-2">üìâ EV Threshold SKIP (manual %)</label>
                            <input type="range" id="evSkip" min="-30" max="-5" value="-15" step="1"
                                class="w-full" oninput="document.getElementById('evSkipVal').textContent = this.value + '%'">
                            <div class="text-red-400 text-sm text-right" id="evSkipVal">-15%</div>
                        </div>
                        <div>
                            <label class="text-primary text-sm block mb-2">üé≤ Prior Bayesiano</label>
                            <select id="priorMode" class="w-full bg-white/10 border border-card rounded-lg px-3 py-2 text-primary">
                                <option value="uniform">Uniforme (1/N outcomes)</option>
                                <option value="fixed">Fijo 50% (binario)</option>
                                <option value="market">Basado en mercado</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-primary text-sm block mb-2">üìù Contexto LLM (caracteres)</label>
                            <input type="range" id="contextLimit" min="300" max="2000" value="1500" step="100"
                                class="w-full" oninput="document.getElementById('contextVal').textContent = this.value">
                            <div class="text-accent text-sm text-right" id="contextVal">1500</div>
                        </div>
                        
                        <!-- NEW: LLM Reasoning Toggle -->
                        <div class="bg-purple-900/20 border border-purple-500/30 rounded-lg p-3">
                            <label class="flex items-center gap-2 text-sm text-primary cursor-pointer">
                                <input type="checkbox" id="enableReasoning" checked
                                    class="w-4 h-4 rounded bg-white/20 border-card">
                                üí° Incluir explicaciones de Claude (+50 tokens/outcome)
                            </label>
                        </div>
                    </div>
                </details>

                <div>
                    <label class="text-primary font-medium block mb-2">‚öôÔ∏è Modo de An√°lisis</label>
                    <select id="analysisMode" class="w-full bg-white/10 border border-card rounded-lg px-4 py-3 text-primary focus:ring-2 focus:ring-accent outline-none">
                        <option value="full">üî• Completo (todos los outcomes)</option>
                        <option value="smart" selected>‚ú® Inteligente (pre-filtro + batch)</option>
                        <option value="top3">üíé Top 3 (m√°ximo ahorro)</option>
                    </select>
                </div>

                <div class="bg-green-900/20 border border-green-500/30 rounded-lg p-4">
                    <div class="flex items-start gap-2">
                        <svg class="w-5 h-5 text-green-400 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                        </svg>
                        <div class="text-green-300 text-sm">
                            <strong>v6.2 ENHANCED:</strong> Prior bayesiano corregido (no m√°s doble-dipping), 
                            liquidez invertida (mercados ineficientes = m√°s EV), explicaciones de Claude opcionales.
                        </div>
                    </div>
                </div>
            </div>

            <button onclick="analyzeMarket()" 
                class="w-full bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white py-4 px-6 rounded-xl font-bold mt-6 transition-all transform hover:scale-[1.02] shadow-2xl">
                üöÄ Analizar con Claude Sonnet 4.5
            </button>
        </div>

        <!-- Loading -->
        <div id="loading" class="hidden card backdrop-blur-lg rounded-2xl p-8 mb-4 border shadow-xl">
            <div class="flex flex-col items-center">
                <svg class="w-16 h-16 text-accent animate-spin mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                </svg>
                <p class="text-primary text-xl font-semibold mb-2">Analizando...</p>
                <p id="loadingStatus" class="text-secondary text-sm">Iniciando...</p>
                <div class="mt-4 w-full bg-white/20 rounded-full h-2">
                    <div id="progressBar" class="bg-accent h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
            </div>
        </div>

        <!-- Results -->
        <div id="results" class="hidden space-y-4"></div>
    </div>

    <script>
        // ============================================================================
        // THEME MANAGEMENT
        // ============================================================================
        
        function toggleTheme() {
            const body = document.body;
            const icon = document.getElementById('themeIcon');
            
            if (body.classList.contains('theme-dark')) {
                body.classList.remove('theme-dark');
                body.classList.add('theme-light');
                localStorage.setItem('theme', 'light');
                icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>';
            } else {
                body.classList.remove('theme-light');
                body.classList.add('theme-dark');
                localStorage.setItem('theme', 'dark');
                icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>';
            }
        }
        
        function loadTheme() {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            if (savedTheme === 'light') {
                document.body.classList.remove('theme-dark');
                document.body.classList.add('theme-light');
                document.getElementById('themeIcon').innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>';
            }
        }
        
        // ============================================================================
        // CONFIGURACI√ìN
        // ============================================================================
        
        const CONFIG = {
            claudeEndpoint: 'https://floral-sea-fdca.onized01.workers.dev',
            claudeModel: 'claude-sonnet-4-5-20250929',
            polymarketAPI: 'https://gamma-api.polymarket.com',
            corsProxy: 'https://api.allorigins.win/raw?url=',
            
            pricing: {
                input: 3.00,
                output: 15.00
            },
            
            dailyLimit: 20,
            cacheExpiry: 3600000,
            
            minVolume: 1000,
            minProb: 0.01,
            maxProb: 0.99
        };

        const WEIGHT_PROFILES = {
            crypto: { hist: 0.15, ctx: 0.05, analog: 0.20, ext: 0.25, mkt: 0.10, sent: 0.20, liq: 0.05 },
            earnings: { hist: 0.35, ctx: 0.20, analog: 0.15, ext: 0.10, mkt: 0.10, sent: 0.05, liq: 0.05 },
            politics: { hist: 0.20, ctx: 0.20, analog: 0.15, ext: 0.10, mkt: 0.05, sent: 0.25, liq: 0.05 },
            sports: { hist: 0.30, ctx: 0.15, analog: 0.25, ext: 0.05, mkt: 0.15, sent: 0.05, liq: 0.05 },
            default: { hist: 0.25, ctx: 0.15, analog: 0.20, ext: 0.15, mkt: 0.10, sent: 0.10, liq: 0.05 }
        };

        const ADAPTIVE_THRESHOLDS = {
            crypto: { buy: 0.20, skip: -0.20 },
            earnings: { buy: 0.12, skip: -0.12 },
            politics: { buy: 0.10, skip: -0.10 },
            sports: { buy: 0.15, skip: -0.15 },
            default: { buy: 0.15, skip: -0.15 }
        };

        let sessionCost = 0;
        let sessionTokens = 0;

        // ============================================================================
        // UI HELPERS
        // ============================================================================
        
        function updateSentimentDisplay() {
            const value = document.getElementById('sentimentOverride').value;
            document.getElementById('sentimentValue').textContent = value + '%';
        }

        // ============================================================================
        // STATS MANAGEMENT
        // ============================================================================

        function loadStats() {
            const today = new Date().toDateString();
            const stats = JSON.parse(localStorage.getItem('app_stats') || '{}');
            
            if (stats.date !== today) {
                stats.date = today;
                stats.count = 0;
                stats.cacheHits = 0;
            }
            
            document.getElementById('todayCount').textContent = stats.count || 0;
            document.getElementById('cacheHits').textContent = stats.cacheHits || 0;
            
            const monthlyTokens = parseInt(localStorage.getItem('monthly_tokens') || '0');
            document.getElementById('totalTokens').textContent = monthlyTokens.toLocaleString();
            
            return stats;
        }

        function updateStats(increment = true, cacheHit = false) {
            const stats = loadStats();
            
            if (increment) stats.count++;
            if (cacheHit) stats.cacheHits++;
            
            localStorage.setItem('app_stats', JSON.stringify(stats));
            loadStats();
        }

        function updateCost(inputTokens, outputTokens) {
            const cost = (inputTokens * CONFIG.pricing.input + outputTokens * CONFIG.pricing.output) / 1000000;
            sessionCost += cost;
            sessionTokens += (inputTokens + outputTokens);
            
            document.getElementById('costTracker').querySelector('.text-green-500').textContent = 
                `$${sessionCost.toFixed(4)}`;
            
            const monthlyTokens = parseInt(localStorage.getItem('monthly_tokens') || '0');
            localStorage.setItem('monthly_tokens', (monthlyTokens + inputTokens + outputTokens).toString());
            loadStats();
        }

        // ============================================================================
        // API KEY & CONFIG
        // ============================================================================

        function loadApiKey() {
            const saved = localStorage.getItem('claude_api_key');
            if (saved) {
                document.getElementById('apiKey').value = saved;
            }
        }

        function saveApiKey() {
            const key = document.getElementById('apiKey').value.trim();
            if (key && key.startsWith('sk-ant-')) {
                localStorage.setItem('claude_api_key', key);
                alert('‚úÖ API Key guardada');
            } else {
                alert('‚ö†Ô∏è Key inv√°lida. Debe empezar con "sk-ant-"');
            }
        }

        window.addEventListener('DOMContentLoaded', () => {
            loadTheme();
            loadApiKey();
            loadStats();
        });

        // ============================================================================
        // CACHE SYSTEM
        // ============================================================================

        function getCachedAnalysis(marketUrl) {
            try {
                const cacheKey = `cache_v62_${btoa(marketUrl).replace(/[^a-zA-Z0-9]/g, '')}`;
                const cached = localStorage.getItem(cacheKey);
                
                if (cached) {
                    const data = JSON.parse(cached);
                    
                    if (!data.results || !data.marketData || !data.config || !data.weights || !data.marketUrl) {
                        console.warn('‚ö†Ô∏è Cach√© incompleto, eliminando');
                        localStorage.removeItem(cacheKey);
                        return null;
                    }
                    
                    if (data.marketUrl !== marketUrl) {
                        console.warn('‚ö†Ô∏è Cach√© de otro mercado, eliminando');
                        localStorage.removeItem(cacheKey);
                        return null;
                    }
                    
                    if (Date.now() - data.timestamp < CONFIG.cacheExpiry) {
                        console.log('‚úÖ Cache HIT v√°lido para:', data.marketData.title);
                        updateStats(false, true);
                        return data;
                    } else {
                        console.log('üïí Cach√© expirado, eliminando');
                        localStorage.removeItem(cacheKey);
                    }
                }
                
                return null;
            } catch (error) {
                console.error('‚ùå Error leyendo cach√©:', error);
                return null;
            }
        }

        function setCachedAnalysis(marketUrl, data) {
            const cacheKey = `cache_v62_${btoa(marketUrl).replace(/[^a-zA-Z0-9]/g, '')}`;
            localStorage.setItem(cacheKey, JSON.stringify({
                ...data,
                marketUrl: marketUrl,
                timestamp: Date.now()
            }));
            console.log('üíæ Cach√© guardado para:', data.marketData.title);
        }

        async function clearAllCache() {
            if (!confirm('¬øLimpiar TODO el cach√©? Esto borrar√° todos los an√°lisis guardados.')) {
                return;
            }
            
            let cleared = 0;
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && (key.startsWith('cache_v6_') || key.startsWith('cache_v62_'))) {
                    localStorage.removeItem(key);
                    cleared++;
                    i--;
                }
            }
            
            alert(`‚úÖ ${cleared} an√°lisis eliminados del cach√©`);
            loadStats();
        }

        // ============================================================================
        // POLYMARKET EXTRACTION
        // ============================================================================

        async function extractMarketData(marketUrl) {
            try {
                const slugMatch = marketUrl.match(/event\/([^?]+)/);
                if (!slugMatch) throw new Error('URL inv√°lida');
                
                const slug = slugMatch[1];
                const apiUrl = `${CONFIG.polymarketAPI}/events?slug=${slug}`;
                const proxiedUrl = `${CONFIG.corsProxy}${encodeURIComponent(apiUrl)}`;
                
                console.log('üîç Fetching:', apiUrl);
                
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 15000);
                
                const response = await fetch(proxiedUrl, { 
                    signal: controller.signal,
                    headers: { 'Accept': 'application/json' }
                });
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    throw new Error(`Error ${response.status}: No se pudo obtener datos del mercado`);
                }

                const events = await response.json();
                
                if (!Array.isArray(events) || events.length === 0) {
                    throw new Error('Mercado no encontrado o sin datos');
                }

                const event = events[0];
                
                if (!event.markets || event.markets.length === 0) {
                    throw new Error('Sin mercados disponibles');
                }

                let category = 'default';
                const title = (event.title || '').toLowerCase();
                if (title.includes('bitcoin') || title.includes('btc') || title.includes('eth')) {
                    category = 'crypto';
                } else if (title.includes('earning') || title.includes('mentions')) {
                    category = 'earnings';
                } else if (title.includes('election') || title.includes('trump') || title.includes('harris')) {
                    category = 'politics';
                } else if (title.includes('super bowl') || title.includes('nba')) {
                    category = 'sports';
                }

                const outcomes = event.markets.map(market => {
                    let marketProb = 0.5;
                    let dataQuality = 'good';
                    
                    if (market.outcomePrices && Array.isArray(market.outcomePrices) && market.outcomePrices.length > 0) {
                        marketProb = parseFloat(market.outcomePrices[0]);
                    } else if (market.clobTokenIds && market.clobTokenIds.length > 0) {
                        marketProb = parseFloat(market.bestAsk || market.lastPrice || 0.5);
                        dataQuality = 'estimated';
                    } else if (typeof market.price === 'number') {
                        marketProb = market.price;
                    } else {
                        dataQuality = 'fallback';
                        console.warn(`‚ö†Ô∏è Using fallback prob for: ${market.question}`);
                    }
                    
                    if (marketProb > 1) marketProb = marketProb / 100;
                    if (marketProb < 0 || marketProb > 1) {
                        marketProb = 0.5;
                        dataQuality = 'fallback';
                    }
                    
                    return {
                        name: market.question || market.groupItemTitle || 'Yes',
                        prob: marketProb,
                        volume_usd: parseFloat(market.volume) || 0,
                        liquidity: parseFloat(market.liquidity) || 0,
                        dataQuality: dataQuality
                    };
                });

                const contextLimit = parseInt(document.getElementById('contextLimit')?.value || 1500);
                const fullContext = event.description || event.title;

                return {
                    title: event.title,
                    context: fullContext.substring(0, contextLimit),
                    category: category,
                    outcomes: outcomes,
                    totalVolume: outcomes.reduce((sum, o) => sum + o.volume_usd, 0),
                    outcomeCount: outcomes.length
                };

            } catch (error) {
                console.error('‚ùå Error:', error);
                if (error.name === 'AbortError') {
                    throw new Error('Timeout: El servidor no respondi√≥ a tiempo');
                }
                throw error;
            }
        }

        // ============================================================================
        // CLAUDE API - VIA WORKER (CORS FIXED) + REASONING
        // ============================================================================

        async function getClaudeScoresBatch(outcomes, marketContext, category, apiKey, sentimentOverride = null, enableReasoning = true) {
            const outcomesList = outcomes.map((o, i) => 
                `${i+1}. "${o.name}" (Market: ${(o.prob*100).toFixed(1)}%, Volume: ${(o.volume_usd/1000).toFixed(0)}k)`
            ).join('\n');
            
            const jsonSchema = {
                type: "array",
                items: {
                    type: "object",
                    properties: {
                        hist: { type: "number", minimum: 0, maximum: 1 },
                        ctx: { type: "number", minimum: 0, maximum: 1 },
                        analog: { type: "number", minimum: 0, maximum: 1 },
                        ext: { type: "number", minimum: 0, maximum: 1 },
                        sent: { type: "number", minimum: 0, maximum: 1 },
                        ...(enableReasoning ? {
                            reasoning: { type: "string", description: "1-2 sentence explanation" }
                        } : {})
                    },
                    required: ["hist", "ctx", "analog", "ext", "sent", ...(enableReasoning ? ["reasoning"] : [])]
                }
            };
            
            let sentimentInstruction = '';
            if (sentimentOverride !== null) {
                sentimentInstruction = `\n\n‚ö†Ô∏è IMPORTANT: The user has manually set sentiment to ${(sentimentOverride*100).toFixed(0)}% based on Twitter/Telegram analysis. You MUST use exactly ${sentimentOverride.toFixed(2)} for ALL "sent" scores. Do not deviate from this value.`;
            }
            
            const reasoningInstruction = enableReasoning 
                ? '\n6. reasoning: A brief 1-2 sentence explanation for your scores (e.g., "Strong historical precedent in similar markets. Recent positive catalysts.")'
                : '';
            
            const prompt = `You are a contrarian prediction market analyst. Your job is to find market inefficiencies.

MARKET CONTEXT:
${marketContext}

CATEGORY: ${category.toUpperCase()}

OUTCOMES TO ANALYZE:
${outcomesList}
${sentimentInstruction}

SCORING INSTRUCTIONS:
For EACH outcome, provide scores from 0.0 to 1.0 for these factors:

1. hist (Historical): How often has this happened historically? (0.2=rare, 0.5=uncertain, 0.8=common)
2. ctx (Catalysts): Current news/events favoring this outcome (0.2=negative, 0.5=neutral, 0.8=strong positive)
3. analog (Analogous): Frequency in similar past situations (0.2=uncommon, 0.5=mixed, 0.8=typical)
4. ext (External): Macro factors, regulations, geopolitics (0.2=headwinds, 0.5=neutral, 0.8=tailwinds)
5. sent (Sentiment): Social media, news, expert opinion (0.2=bearish, 0.5=mixed, 0.8=bullish)${sentimentOverride !== null ? ` - USE EXACTLY ${sentimentOverride.toFixed(2)} FOR ALL OUTCOMES` : ''}${reasoningInstruction}

CRITICAL RULES:
- Be OPINIONATED. Use the full 0.2-0.8 range. Don't default to 0.5 unless truly uncertain.
- Look for MISPRICING. If market is at 50% but fundamentals suggest 70%, score accordingly.
- Consider VOLUME. Low volume = more potential mispricing.
- Think CONTRARIAN. The crowd is often wrong.

OUTPUT:
Return a JSON array with exactly ${outcomes.length} objects matching this schema:
${JSON.stringify(jsonSchema, null, 2)}

Example:
[
  {"hist": 0.65, "ctx": 0.72, "analog": 0.58, "ext": 0.45, "sent": 0.80${enableReasoning ? ', "reasoning": "Strong historical precedent. Recent positive catalysts."' : ''}}
]

RESPOND WITH ONLY THE JSON ARRAY. NO EXPLANATIONS OUTSIDE THE JSON.`;

            try {
                console.log('ü§ñ Calling Claude API via Worker...');
                if (sentimentOverride !== null) {
                    console.log(`üê¶ Using sentiment override: ${(sentimentOverride*100).toFixed(0)}%`);
                }
                
                const response = await fetch(CONFIG.claudeEndpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        apiKey: apiKey,
                        body: {
                            model: CONFIG.claudeModel,
                            max_tokens: enableReasoning ? 3000 : 2000,
                            temperature: 0.3,
                            messages: [{
                                role: 'user',
                                content: prompt
                            }]
                        }
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('‚ùå API Error Response:', errorText);
                    throw new Error(`Claude API error ${response.status}`);
                }

                const data = await response.json();
                console.log('‚úÖ Claude response received');
                
                if (!data.content || !Array.isArray(data.content) || data.content.length === 0) {
                    throw new Error('Invalid response structure from Claude');
                }
                
                if (!data.content[0].text) {
                    throw new Error('No text in Claude response');
                }
                
                updateCost(data.usage.input_tokens, data.usage.output_tokens);
                
                let content = data.content[0].text.trim();
                content = content.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
                
                const jsonMatch = content.match(/\[[\s\S]*\]/);
                if (jsonMatch) {
                    content = jsonMatch[0];
                }

                const scoresArray = JSON.parse(content);
                
                if (!Array.isArray(scoresArray)) {
                    throw new Error('Response is not an array');
                }
                
                if (scoresArray.length !== outcomes.length) {
                    console.warn(`‚ö†Ô∏è Expected ${outcomes.length} scores, got ${scoresArray.length}`);
                }
                
                return scoresArray.map((scores, idx) => {
                    const normalized = {};
                    ['hist', 'ctx', 'analog', 'ext', 'sent'].forEach(cat => {
                        if (!(cat in scores)) {
                            console.warn(`Missing ${cat} in outcome ${idx}, using 0.50`);
                            normalized[cat] = 0.50;
                        } else {
                            normalized[cat] = Math.max(0.0, Math.min(1.0, parseFloat(scores[cat]) || 0.50));
                        }
                        
                        if (cat === 'sent' && sentimentOverride !== null) {
                            normalized[cat] = sentimentOverride;
                        }
                    });
                    
                    if (enableReasoning && scores.reasoning) {
                        normalized.reasoning = scores.reasoning;
                    }
                    
                    return normalized;
                });

            } catch (error) {
                console.error('üí• Claude API Error:', error);
                console.error('Stack:', error.stack);
                
                console.warn('‚ö†Ô∏è Using neutral fallback scores');
                const baseSent = sentimentOverride !== null ? sentimentOverride : 0.50;
                return outcomes.map(() => ({
                    hist: 0.50, ctx: 0.50, analog: 0.50, ext: 0.50, sent: baseSent,
                    ...(enableReasoning ? { reasoning: "Fallback scores due to API error" } : {})
                }));
            }
        }

        // ============================================================================
        // ENHANCED BAYESIAN CALCULATION (v6.2)
        // ============================================================================

        function calculateBayesian(scores, weights, marketProb, liquidityRatio, prior) {
            // ‚úÖ FIXED: Inverted liquidity - low liquidity = high inefficiency = more opportunity
            const inefficiencyScore = 1 - Math.min(liquidityRatio, 0.9);
            
            scores.mkt = marketProb;
            scores.liq = inefficiencyScore;

            const weightedSum = Object.keys(weights).reduce((sum, cat) => 
                sum + weights[cat] * (scores[cat] || 0.50), 0);

            // ‚úÖ FIXED: Proper Bayesian update - no double-dipping of prior
            const scoreValues = Object.values(scores).filter(v => typeof v === 'number');
            const variance = scoreValues.reduce((sum, s) => 
                sum + Math.pow(s - weightedSum, 2), 0) / scoreValues.length;
            const confidence = 1.0 - Math.min(variance, 0.3);
            
            // Bayesian update: prior strength vs data strength
            const priorStrength = 1.0;
            const dataStrength = confidence * 8;
            const posterior = (prior * priorStrength + weightedSum * dataStrength) / (priorStrength + dataStrength);
            
            // Market weight based on liquidity: high liquidity = trust market more
            const marketWeight = Math.min(liquidityRatio * 0.6, 0.5);
            const ourWeight = 1 - marketWeight;
            
            let finalProb = ourWeight * posterior + marketWeight * marketProb;
            finalProb = Math.max(0.01, Math.min(0.99, finalProb));

            return { 
                probability: finalProb, 
                confidence, 
                posterior,
                weightedSum,
                inefficiencyScore,
                marketWeight,
                rawScores: {...scores}
            };
        }

        // ============================================================================
        // MAIN ANALYSIS
        // ============================================================================

        async function analyzeMarket() {
            const apiKey = document.getElementById('apiKey').value.trim();
            const marketUrl = document.getElementById('marketUrl').value.trim();
            const mode = document.getElementById('analysisMode').value;
            const priorMode = document.getElementById('priorMode').value;
            const enableReasoning = document.getElementById('enableReasoning')?.checked ?? true;
            
            const useSentimentOverride = document.getElementById('useSentimentOverride').checked;
            const sentimentOverride = useSentimentOverride 
                ? parseFloat(document.getElementById('sentimentOverride').value) / 100 
                : null;
            
            const useAdaptiveThresholds = document.getElementById('useAdaptiveThresholds')?.checked ?? true;

            if (!apiKey || !apiKey.startsWith('sk-ant-')) {
                alert('‚ö†Ô∏è Ingresa una API Key v√°lida');
                return;
            }

            if (!marketUrl) {
                alert('‚ö†Ô∏è Ingresa la URL del mercado');
                return;
            }

            const stats = loadStats();
            if (stats.count >= CONFIG.dailyLimit) {
                alert(`‚ö†Ô∏è L√≠mite diario alcanzado (${CONFIG.dailyLimit})`);
                return;
            }

            const cached = getCachedAnalysis(marketUrl);
            if (cached && cached.marketData && cached.results && cached.config) {
                console.log('‚úÖ Usando cach√© v√°lido:', cached.marketData.title);
                displayResults(cached.results, cached.marketData, cached.weights, cached.category, cached.config);
                return;
            }

            document.getElementById('inputSection').classList.add('hidden');
            document.getElementById('results').classList.add('hidden');
            document.getElementById('loading').classList.remove('hidden');
            updateProgress(10, 'üì° Extrayendo datos del mercado...');

            let marketData;
            try {
                marketData = await extractMarketData(marketUrl);
                updateProgress(30, `‚úÖ ${marketData.outcomes.length} outcomes encontrados`);
            } catch (error) {
                showError(`Error obteniendo datos: ${error.message}`);
                return;
            }

            let prior = 0.50;
            if (priorMode === 'uniform') {
                prior = 1.0 / marketData.outcomeCount;
                console.log(`üìä Prior uniforme: ${prior.toFixed(3)} (1/${marketData.outcomeCount})`);
            } else if (priorMode === 'market') {
                prior = marketData.outcomes.reduce((sum, o) => sum + o.prob, 0) / marketData.outcomes.length;
                console.log(`üìä Prior basado en mercado: ${prior.toFixed(3)}`);
            }

            let evBuy, evSkip;
            if (useAdaptiveThresholds) {
                const thresholds = ADAPTIVE_THRESHOLDS[marketData.category] || ADAPTIVE_THRESHOLDS.default;
                evBuy = thresholds.buy;
                evSkip = thresholds.skip;
                console.log(`üìä Thresholds adaptativos (${marketData.category}): +${(evBuy*100).toFixed(0)}% / ${(evSkip*100).toFixed(0)}%`);
            } else {
                evBuy = parseFloat(document.getElementById('evBuy').value) / 100;
                evSkip = parseFloat(document.getElementById('evSkip').value) / 100;
                console.log(`üìä Thresholds manuales: +${(evBuy*100).toFixed(0)}% / ${(evSkip*100).toFixed(0)}%`);
            }

            let outcomesToAnalyze = marketData.outcomes;
            
            if (mode === 'smart') {
                outcomesToAnalyze = marketData.outcomes.filter(o => 
                    o.volume_usd > CONFIG.minVolume && 
                    o.prob > CONFIG.minProb && 
                    o.prob < CONFIG.maxProb
                );
                if (outcomesToAnalyze.length === 0) {
                    console.warn('‚ö†Ô∏è Filtro smart muy restrictivo, usando todos los outcomes');
                    outcomesToAnalyze = marketData.outcomes;
                }
            } else if (mode === 'top3') {
                outcomesToAnalyze = marketData.outcomes
                    .sort((a, b) => b.volume_usd - a.volume_usd)
                    .slice(0, 3);
            }
            
            console.log(`üìä Analizando ${outcomesToAnalyze.length} de ${marketData.outcomes.length} outcomes`);

            updateProgress(40, `üß† Analizando ${outcomesToAnalyze.length} outcomes con Claude...`);

            const weights = WEIGHT_PROFILES[marketData.category] || WEIGHT_PROFILES.default;
            
            const scoresArray = await getClaudeScoresBatch(
                outcomesToAnalyze,
                marketData.context,
                marketData.category,
                apiKey,
                sentimentOverride,
                enableReasoning
            );

            updateProgress(70, 'üî¢ Calculando probabilidades bayesianas...');

            const results = outcomesToAnalyze.map((outcome, i) => {
                const liquidityRatio = outcome.liquidity / Math.max(marketData.totalVolume, 1);
                const bayesianResult = calculateBayesian(scoresArray[i], weights, outcome.prob, liquidityRatio, prior);
                const ev = bayesianResult.probability - outcome.prob;

                let verdict = '‚öñÔ∏è NEUTRAL';
                if (ev > evBuy) verdict = 'üî• COMPRA';
                else if (ev < evSkip) verdict = 'üö® SKIP';

                let bias = 'Neutral';
                const diff = bayesianResult.probability - outcome.prob;
                if (Math.abs(diff) < 0.05) bias = 'Neutral';
                else if (diff > 0.15) bias = 'Subestimado';
                else if (diff < -0.15) bias = 'Sobreestimado';
                else if (diff > 0) bias = 'Leve subestimaci√≥n';
                else bias = 'Leve sobreestimaci√≥n';

                return {
                    name: outcome.name,
                    marketProb: outcome.prob,
                    ourProb: bayesianResult.probability,
                    ev: ev,
                    bias: bias,
                    verdict: verdict,
                    confidence: bayesianResult.confidence,
                    volume: outcome.volume_usd,
                    liquidity: outcome.liquidity,
                    rawScores: bayesianResult.rawScores,
                    posterior: bayesianResult.posterior,
                    weightedSum: bayesianResult.weightedSum,
                    inefficiencyScore: bayesianResult.inefficiencyScore,
                    marketWeight: bayesianResult.marketWeight,
                    dataQuality: outcome.dataQuality,
                    reasoning: scoresArray[i].reasoning || null
                };
            });

            results.sort((a, b) => b.ev - a.ev);

            const analysisConfig = {
                evBuy: evBuy,
                evSkip: evSkip,
                prior: prior,
                priorMode: priorMode,
                weights: weights,
                useAdaptiveThresholds: useAdaptiveThresholds,
                sentimentOverride: sentimentOverride,
                enableReasoning: enableReasoning
            };

            setCachedAnalysis(marketUrl, {
                results: results,
                marketData: marketData,
                weights: weights,
                category: marketData.category,
                config: analysisConfig
            });

            updateStats(true, false);
            updateProgress(100, '‚ú® An√°lisis completado');
            await new Promise(r => setTimeout(r, 500));
            displayResults(results, marketData, weights, marketData.category, analysisConfig);
        }

        // ============================================================================
        // UI HELPERS
        // ============================================================================

        function updateProgress(percent, status) {
            document.getElementById('progressBar').style.width = `${percent}%`;
            document.getElementById('loadingStatus').textContent = status;
        }

        function showError(message) {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('inputSection').classList.remove('hidden');
            
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = `
                <div class="card backdrop-blur-lg rounded-2xl p-6 border">
                    <h3 class="text-xl font-bold text-red-500 mb-3">‚ùå Error</h3>
                    <p class="text-primary mb-4">${message}</p>
                    <button onclick="resetAnalysis()" 
                        class="bg-white/20 hover:bg-white/30 text-primary py-2 px-4 rounded-lg">
                        Reintentar
                    </button>
                </div>
            `;
            resultsDiv.classList.remove('hidden');
        }

        // ============================================================================
        // DISPLAY RESULTS (THEME-AWARE)
        // ============================================================================

        function displayResults(results, marketData, weights, category, config) {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '';

            let html = `
                <div class="bg-gradient-to-r from-cyan-600 to-blue-700 rounded-2xl p-6 border border-white/20 shadow-xl">
                    <h2 class="text-2xl font-bold text-white mb-3">üìä ${marketData.title}</h2>
                    <div class="grid grid-cols-2 gap-3 text-sm">
                        <div class="bg-white/20 rounded-lg p-3">
                            <div class="text-cyan-100 mb-1">Categor√≠a</div>
                            <div class="text-white font-semibold">${category.toUpperCase()}</div>
                        </div>
                        <div class="bg-white/20 rounded-lg p-3">
                            <div class="text-cyan-100 mb-1">Volumen</div>
                            <div class="text-white font-semibold">${(marketData.totalVolume/1000).toFixed(0)}k</div>
                        </div>
                        <div class="bg-white/20 rounded-lg p-3">
                            <div class="text-cyan-100 mb-1">Prior</div>
                            <div class="text-white font-semibold">${(config.prior * 100).toFixed(1)}% (${config.priorMode})</div>
                        </div>
                        <div class="bg-white/20 rounded-lg p-3">
                            <div class="text-cyan-100 mb-1">Thresholds</div>
                            <div class="text-white font-semibold text-xs">
                                ${config.useAdaptiveThresholds ? 
                                    `+${(config.evBuy*100).toFixed(0)}% / ${(config.evSkip*100).toFixed(0)}% (adaptativo)` :
                                    `+${(config.evBuy*100).toFixed(0)}% / ${(config.evSkip*100).toFixed(0)}% (manual)`
                                }
                            </div>
                        </div>
                        ${config.sentimentOverride !== null ? `
                        <div class="bg-blue-900/40 rounded-lg p-3 border border-blue-400/50 col-span-2">
                            <div class="text-blue-200 mb-1 flex items-center gap-1">
                                <span>üê¶</span>
                                <span>Sentiment Override</span>
                            </div>
                            <div class="text-white font-semibold">${(config.sentimentOverride*100).toFixed(0)}%</div>
                        </div>
                        ` : ''}
                    </div>
                </div>
            `;

            const buys = results.filter(r => r.verdict === 'üî• COMPRA');
            if (buys.length > 0) {
                html += `
                    <div class="card backdrop-blur-lg rounded-2xl p-6 border shadow-xl">
                        <h3 class="text-xl font-bold text-primary mb-4">üî• TOP OPORTUNIDADES (${buys.length})</h3>
                        <div class="space-y-3">
                `;

                for (const r of buys.slice(0, 5)) {
                    const dataQualityBadge = r.dataQuality === 'fallback' 
                        ? '<span class="text-yellow-400 text-xs ml-2">‚ö†Ô∏è Prob estimada</span>' 
                        : '';
                    
                    html += `
                        <div class="bg-green-900/30 border border-green-500/50 rounded-lg p-4">
                            <div class="flex justify-between items-start mb-3">
                                <span class="text-primary font-semibold text-lg">${r.name}${dataQualityBadge}</span>
                                <span class="text-green-400 font-bold text-2xl">+${(r.ev*100).toFixed(1)}%</span>
                            </div>
                            <div class="grid grid-cols-4 gap-3 text-sm mb-3">
                                <div>
                                    <div class="text-secondary">Mercado</div>
                                    <div class="text-primary font-medium">${(r.marketProb*100).toFixed(1)}%</div>
                                </div>
                                <div>
                                    <div class="text-secondary">Nuestra</div>
                                    <div class="text-primary font-medium">${(r.ourProb*100).toFixed(1)}%</div>
                                </div>
                                <div>
                                    <div class="text-secondary">Confianza</div>
                                    <div class="text-primary font-medium">${(r.confidence*100).toFixed(0)}%</div>
                                </div>
                                <div>
                                    <div class="text-secondary">Ineficiencia</div>
                                    <div class="text-primary font-medium">${(r.inefficiencyScore*100).toFixed(0)}%</div>
                                </div>
                            </div>
                            ${r.reasoning ? `
                            <details class="text-xs mb-2">
                                <summary class="text-purple-400 cursor-pointer mb-2">üí° Razonamiento de Claude</summary>
                                <div class="bg-purple-900/30 rounded p-3 text-purple-200 text-sm mt-2">
                                    ${r.reasoning}
                                </div>
                            </details>
                            ` : ''}
                            <details class="text-xs">
                                <summary class="text-yellow-400 cursor-pointer mb-2">üìä Ver scores detallados</summary>
                                <div class="bg-black/30 rounded p-3 space-y-1 text-secondary">
                                    <div class="flex justify-between">
                                        <span>hist (hist√≥rico):</span>
                                        <span class="text-primary">${(r.rawScores.hist*100).toFixed(0)}%</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>ctx (catalizadores):</span>
                                        <span class="text-primary">${(r.rawScores.ctx*100).toFixed(0)}%</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>analog (an√°logos):</span>
                                        <span class="text-primary">${(r.rawScores.analog*100).toFixed(0)}%</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>ext (externos):</span>
                                        <span class="text-primary">${(r.rawScores.ext*100).toFixed(0)}%</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>sent (sentiment):</span>
                                        <span class="text-primary">${(r.rawScores.sent*100).toFixed(0)}%</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>mkt (mercado):</span>
                                        <span class="text-primary">${(r.rawScores.mkt*100).toFixed(0)}%</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>liq (ineficiencia):</span>
                                        <span class="text-primary">${(r.rawScores.liq*100).toFixed(0)}%</span>
                                    </div>
                                    <div class="flex justify-between border-t border-white/20 pt-1 mt-1">
                                        <span class="font-bold">Weighted Sum:</span>
                                        <span class="text-accent font-bold">${(r.weightedSum*100).toFixed(1)}%</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="font-bold">Market Weight:</span>
                                        <span class="text-accent font-bold">${(r.marketWeight*100).toFixed(0)}%</span>
                                    </div>
                                </div>
                            </details>
                        </div>
                    `;
                }

                html += '</div></div>';
            }

            html += `
                <div class="card backdrop-blur-lg rounded-2xl p-6 border shadow-xl">
                    <h3 class="text-xl font-bold text-primary mb-4">üìã An√°lisis Completo</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead>
                                <tr class="border-b border-card">
                                    <th class="text-left text-secondary py-2">Outcome</th>
                                    <th class="text-right text-secondary py-2">Market</th>
                                    <th class="text-right text-secondary py-2">Nuestra</th>
                                    <th class="text-right text-secondary py-2">EV</th>
                                    <th class="text-center text-secondary py-2">Acci√≥n</th>
                                </tr>
                            </thead>
                            <tbody>
            `;

            for (const r of results) {
                const evColor = r.ev > 0 ? 'text-green-500' : (r.ev < 0 ? 'text-red-500' : 'text-secondary');
                html += `
                    <tr class="border-b border-card hover:bg-white/5">
                        <td class="py-3 text-primary">${r.name.substring(0, 40)}</td>
                        <td class="text-right text-secondary">${(r.marketProb*100).toFixed(1)}%</td>
                        <td class="text-right text-primary font-medium">${(r.ourProb*100).toFixed(1)}%</td>
                        <td class="text-right ${evColor} font-bold">${r.ev > 0 ? '+' : ''}${(r.ev*100).toFixed(1)}%</td>
                        <td class="text-center text-xs">${r.verdict}</td>
                    </tr>
                `;
            }

            html += `
                            </tbody>
                        </table>
                    </div>
                </div>
            `;

            if (buys.length > 0) {
                const totalEV = buys.reduce((sum, r) => sum + r.ev, 0);
                html += `
                    <div class="card backdrop-blur-lg rounded-2xl p-6 border shadow-xl">
                        <h3 class="text-xl font-bold text-primary mb-3">üí∞ Portfolio Sugerido</h3>
                        <div class="bg-green-900/30 border border-green-500/50 rounded-lg p-4 mb-4">
                            <div class="text-green-400 font-bold text-3xl mb-1">
                                EV Total: +${(totalEV*100).toFixed(1)}%
                            </div>
                            <div class="text-secondary text-sm">
                                Distribuir equitativamente en top ${Math.min(5, buys.length)}
                            </div>
                        </div>
                        <div class="space-y-2">
                `;

                const topBuys = buys.slice(0, 5);
                const weight = 100 / topBuys.length;

                for (const r of topBuys) {
                    html += `
                        <div class="flex justify-between items-center bg-white/5 rounded-lg p-3">
                            <span class="text-primary">${r.name.substring(0, 45)}</span>
                            <span class="text-accent font-bold">${weight.toFixed(0)}%</span>
                        </div>
                    `;
                }

                html += '</div></div>';
            }

            html += `
                <div class="card backdrop-blur-lg rounded-2xl p-6 border shadow-xl">
                    <h3 class="text-xl font-bold text-primary mb-3">üß† Metodolog√≠a v6.2</h3>
                    <div class="space-y-2 text-sm text-secondary">
                        <div class="flex justify-between">
                            <span>Modelo:</span>
                            <span class="text-primary">Claude Sonnet 4.5</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Backend:</span>
                            <span class="text-green-500">Cloudflare Worker ‚úì</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Prior bayesiano:</span>
                            <span class="text-primary">${(config.prior*100).toFixed(1)}% (${config.priorMode})</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Perfil de pesos:</span>
                            <span class="text-primary">${category.toUpperCase()}</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Explicaciones LLM:</span>
                            <span class="text-primary">${config.enableReasoning ? 'Activadas' : 'Desactivadas'}</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Costo an√°lisis:</span>
                            <span class="text-green-500">${sessionCost.toFixed(4)}</span>
                        </div>
                    </div>
                    <details class="mt-4 pt-3 border-t border-card">
                        <summary class="text-accent cursor-pointer text-sm font-medium mb-2">Ver pesos detallados</summary>
                        <div class="grid grid-cols-2 gap-2 text-xs text-secondary">
                            ${Object.entries(weights).map(([k, v]) => `
                                <div class="flex justify-between bg-white/5 rounded px-2 py-1">
                                    <span>${k}:</span>
                                    <span class="text-primary">${(v*100).toFixed(0)}%</span>
                                </div>
                            `).join('')}
                        </div>
                    </details>
                    <div class="mt-3 pt-3 border-t border-card">
                        <div class="text-xs text-secondary">
                            <strong class="text-primary">v6.2 Enhanced:</strong> 
                            ‚úÖ Prior bayesiano corregido (no double-dipping)
                            <br>‚úÖ Liquidez invertida (ineficiencia = oportunidad)
                            <br>‚úÖ Explicaciones opcionales de Claude
                            <br>‚úÖ Data quality warnings
                            <br>‚úÖ Theme claro/oscuro
                            ${config.sentimentOverride !== null ? `<br>üê¶ <span class="text-blue-400">Sentiment: ${(config.sentimentOverride*100).toFixed(0)}%</span>` : ''}
                        </div>
                    </div>
                </div>
            `;

            html += `
                <button onclick="resetAnalysis()" 
                    class="w-full bg-white/20 hover:bg-white/30 text-primary py-3 px-6 rounded-xl font-semibold transition-all flex items-center justify-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                    Analizar Otro Mercado
                </button>
            `;

            resultsDiv.innerHTML = html;
            document.getElementById('loading').classList.add('hidden');
            resultsDiv.classList.remove('hidden');
        }

        function resetAnalysis() {
            document.getElementById('inputSection').classList.remove('hidden');
            document.getElementById('results').classList.add('hidden');
        }
    </script>
</body>
</html>