<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Predictor Pro AI v3.0 - Grok Powered</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .animate-spin { animation: spin 1s linear infinite; }
    </style>
</head>
<body class="bg-gradient-to-br from-indigo-900 via-purple-900 to-pink-900 min-h-screen p-4">
    <div class="max-w-4xl mx-auto">
        <!-- Header -->
        <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-6 mb-4 border border-white/20 shadow-xl">
            <div class="flex items-center gap-3 mb-2">
                <svg class="w-8 h-8 text-cyan-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                </svg>
                <div>
                    <h1 class="text-2xl font-bold text-white">Predictor Pro AI v3.0</h1>
                    <p class="text-gray-300 text-xs">Grok-3 analiza TODO autom√°ticamente</p>
                </div>
            </div>
        </div>

        <!-- Configuraci√≥n Simple -->
        <div id="inputSection" class="bg-white/10 backdrop-blur-lg rounded-2xl p-6 mb-4 border border-white/20 shadow-xl">
            <h2 class="text-xl font-semibold text-white mb-4">üéØ An√°lisis Inteligente</h2>
            
            <div class="space-y-4">
                <div>
                    <label class="text-white font-medium block mb-2">üîë xAI API Key</label>
                    <input type="password" id="apiKey" placeholder="xai-..." 
                        class="w-full bg-white/20 border border-white/30 rounded-lg px-4 py-3 text-white placeholder-gray-400 focus:ring-2 focus:ring-cyan-400 outline-none">
                    <p class="text-gray-400 text-xs mt-1">
                        Obt√©n gratis en <a href="https://x.ai/api" target="_blank" class="text-cyan-400 underline">x.ai/api</a> 
                        ($25 cr√©ditos gratis)
                    </p>
                </div>

                <div>
                    <label class="text-white font-medium block mb-2">üîó URL del Mercado (Polymarket)</label>
                    <input type="text" id="marketUrl" 
                        placeholder="https://polymarket.com/event/bitcoin-price-on-november-4?tid=..."
                        class="w-full bg-white/20 border border-white/30 rounded-lg px-4 py-3 text-white placeholder-gray-400 focus:ring-2 focus:ring-cyan-400 outline-none">
                    <p class="text-gray-400 text-xs mt-1">
                        ‚ö° Grok extraer√° autom√°ticamente outcomes, probabilidades y comparar√° con Kalshi
                    </p>
                </div>

                <div class="bg-blue-900/30 border border-blue-700/50 rounded-lg p-4">
                    <div class="flex items-start gap-2">
                        <svg class="w-5 h-5 text-blue-400 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <div class="text-blue-200 text-sm">
                            <strong>Nuevo:</strong> Grok analizar√° el mercado completo, detectar√° si es binario o multi-outcome, 
                            buscar√° mercados comparables en Kalshi/Metaculus, y calcular√° EV con el algoritmo bayesiano mejorado.
                        </div>
                    </div>
                </div>
            </div>

            <button onclick="analyzeMarketSmart()" 
                class="w-full bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 text-white py-4 px-6 rounded-xl font-bold mt-6 transition-all transform hover:scale-[1.02] shadow-2xl">
                üöÄ Analizar con Grok-3
            </button>
        </div>

        <!-- Loading Mejorado -->
        <div id="loading" class="hidden bg-white/10 backdrop-blur-lg rounded-2xl p-8 mb-4 border border-white/20 shadow-xl">
            <div class="flex flex-col items-center">
                <svg class="w-16 h-16 text-cyan-400 animate-spin mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                </svg>
                <p class="text-white text-xl font-semibold mb-2">Analizando con Grok-3...</p>
                <p id="loadingStatus" class="text-gray-400 text-sm">Extrayendo datos del mercado...</p>
                <div class="mt-4 w-full bg-white/20 rounded-full h-2">
                    <div id="progressBar" class="bg-cyan-400 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
            </div>
        </div>

        <!-- Resultados -->
        <div id="results" class="hidden space-y-4"></div>
    </div>

    <script>
        // ============================================================================
        // CONFIGURACI√ìN
        // ============================================================================
        
        const CONFIG = {
            xaiEndpoint: 'https://api.x.ai/v1/chat/completions',
            xaiModel: 'grok-beta',
            prior: 0.50,
            evThresholdBuy: 0.15,
            evThresholdSkip: -0.15
        };

        const WEIGHT_PROFILES = {
            crypto: { hist: 0.15, ctx: 0.05, analog: 0.20, ext: 0.25, mkt: 0.10, sent: 0.20, liq: 0.05 },
            earnings: { hist: 0.35, ctx: 0.20, analog: 0.15, ext: 0.10, mkt: 0.10, sent: 0.05, liq: 0.05 },
            politics: { hist: 0.20, ctx: 0.20, analog: 0.15, ext: 0.10, mkt: 0.05, sent: 0.25, liq: 0.05 },
            sports: { hist: 0.30, ctx: 0.15, analog: 0.25, ext: 0.05, mkt: 0.15, sent: 0.05, liq: 0.05 },
            default: { hist: 0.25, ctx: 0.15, analog: 0.20, ext: 0.15, mkt: 0.10, sent: 0.10, liq: 0.05 }
        };

        // ============================================================================
        // FASE 1: EXTRACCI√ìN INTELIGENTE CON GROK
        // ============================================================================

        async function extractMarketData(marketUrl, apiKey) {
            const prompt = `Eres un experto en prediction markets. Analiza esta URL de Polymarket y extrae TODA la informaci√≥n:

**URL**: ${marketUrl}

**TAREA**: Visita mentalmente este mercado y extr√°eme:

1. **T√≠tulo del mercado** (completo)
2. **Tipo de mercado**: 
   - "binary" si es Yes/No
   - "multi" si tiene m√∫ltiples outcomes (ej: BTC price ranges, earnings mentions)
3. **Outcomes** (TODOS los posibles resultados):
   - Para binarios: ["Yes", "No"]
   - Para multi: Lista completa (ej: ["BTC < $50k", "BTC $50k-$75k", ...])
4. **Probabilidades actuales** de cada outcome (en decimal 0.0-1.0)
5. **Volumen** de cada outcome en USD (si disponible)
6. **Contexto clave**: ¬øDe qu√© trata este mercado? (1-2 frases)

**CR√çTICO**: 
- Si es un mercado crypto, detecta los rangos de precio exactos
- Si es earnings, lista TODAS las palabras/menciones
- Si no puedes acceder a la URL, usa el slug/t√≠tulo para inferir outcomes t√≠picos

**OUTPUT**: JSON puro sin markdown
{
  "title": "...",
  "type": "binary" o "multi",
  "context": "...",
  "market_category": "crypto/earnings/politics/sports/other",
  "outcomes": [
    {"name": "...", "prob": 0.XX, "volume_usd": XXXXX},
    ...
  ]
}`;

            try {
                const response = await fetch(CONFIG.xaiEndpoint, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: CONFIG.xaiModel,
                        messages: [
                            {role: 'system', content: 'Eres un analista de prediction markets. Output JSON puro.'},
                            {role: 'user', content: prompt}
                        ],
                        temperature: 0.2,
                        max_tokens: 800
                    })
                });

                if (!response.ok) throw new Error(`API error: ${response.status}`);

                const data = await response.json();
                let content = data.choices[0].message.content;

                // Limpiar markdown
                if (content.includes('```json')) {
                    content = content.split('```json')[1].split('```')[0].trim();
                } else if (content.includes('```')) {
                    content = content.split('```')[1].split('```')[0].trim();
                }

                return JSON.parse(content);

            } catch (error) {
                console.error('Error extrayendo market data:', error);
                return null;
            }
        }

        // ============================================================================
        // FASE 2: COMPARACI√ìN CON OTROS MERCADOS (KALSHI/METACULUS)
        // ============================================================================

        async function findComparableMarkets(marketTitle, marketContext, apiKey) {
            const prompt = `Busca mercados similares en Kalshi y Metaculus para comparar:

**Mercado Polymarket**: ${marketTitle}
**Contexto**: ${marketContext}

**TAREA**: 
1. ¬øExiste un mercado equivalente en Kalshi sobre el mismo tema?
2. ¬øExiste en Metaculus?
3. Si existen, ¬øcu√°les son las probabilidades actuales all√≠?

**OUTPUT JSON**:
{
  "kalshi_exists": true/false,
  "kalshi_prob": 0.XX (si existe),
  "kalshi_market": "nombre del mercado" (si existe),
  "metaculus_exists": true/false,
  "metaculus_prob": 0.XX (si existe),
  "consensus_analysis": "breve an√°lisis de si los mercados est√°n alineados"
}

Si no existen mercados comparables, pon exists: false.`;

            try {
                const response = await fetch(CONFIG.xaiEndpoint, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: CONFIG.xaiModel,
                        messages: [
                            {role: 'system', content: 'Eres experto en prediction markets. Output JSON.'},
                            {role: 'user', content: prompt}
                        ],
                        temperature: 0.2,
                        max_tokens: 400
                    })
                });

                if (!response.ok) return null;

                const data = await response.json();
                let content = data.choices[0].message.content;

                if (content.includes('```json')) {
                    content = content.split('```json')[1].split('```')[0].trim();
                } else if (content.includes('```')) {
                    content = content.split('```')[1].split('```')[0].trim();
                }

                return JSON.parse(content);

            } catch (error) {
                console.error('Error buscando mercados comparables:', error);
                return null;
            }
        }

        // ============================================================================
        // FASE 3: AN√ÅLISIS BAYESIANO CON GROK
        // ============================================================================

        async function getGrokScores(outcome, marketContext, marketCategory, apiKey) {
            const prompt = `Analiza objetivamente este outcome en un mercado de predicci√≥n:

**Mercado**: ${marketContext}
**Outcome espec√≠fico**: ${outcome}
**Categor√≠a**: ${marketCategory}

Dame scores 0.00-1.00 (0.50 = neutral) para:

1. **hist**: Precedentes hist√≥ricos que apoyen este outcome
2. **ctx**: Catalizadores/noticias actuales que lo favorezcan
3. **analog**: Frecuencia de este outcome en casos similares pasados
4. **ext**: Factores externos (macro, regulatorios) que influyan
5. **sent**: Sentiment en redes sociales/news (0.20=muy negativo, 0.80=muy positivo)
6. **liq**: Calidad del mercado (0.80=alta liquidez/confiable, 0.20=baja liquidez/riesgoso)

**IMPORTANTE**:
- Prior neutral: 0.50
- Solo desv√≠ate con evidencia concreta
- S√© objetivo, no optimista ni pesimista por defecto

**OUTPUT JSON puro**:
{"hist": 0.XX, "ctx": 0.XX, "analog": 0.XX, "ext": 0.XX, "sent": 0.XX, "liq": 0.XX}`;

            try {
                const response = await fetch(CONFIG.xaiEndpoint, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: CONFIG.xaiModel,
                        messages: [
                            {role: 'system', content: 'Analista cuantitativo objetivo. Output JSON puro.'},
                            {role: 'user', content: prompt}
                        ],
                        temperature: 0.1,
                        max_tokens: 200
                    })
                });

                if (!response.ok) throw new Error(`API error: ${response.status}`);

                const data = await response.json();
                let content = data.choices[0].message.content;

                if (content.includes('```json')) {
                    content = content.split('```json')[1].split('```')[0].trim();
                } else if (content.includes('```')) {
                    content = content.split('```')[1].split('```')[0].trim();
                }

                const scores = JSON.parse(content);

                // Validar scores
                ['hist', 'ctx', 'analog', 'ext', 'sent', 'liq'].forEach(cat => {
                    if (!(cat in scores)) scores[cat] = 0.50;
                    scores[cat] = Math.max(0.0, Math.min(1.0, parseFloat(scores[cat])));
                });

                return scores;

            } catch (error) {
                console.error('Error obteniendo scores:', error);
                return { hist: 0.50, ctx: 0.50, analog: 0.50, ext: 0.50, sent: 0.50, liq: 0.50 };
            }
        }

        // ============================================================================
        // C√ÅLCULO BAYESIANO
        // ============================================================================

        function calculateBayesian(scores, weights, marketProb) {
            scores.mkt = marketProb;

            const weightedSum = Object.keys(weights).reduce((sum, cat) => 
                sum + weights[cat] * (scores[cat] || 0.50), 0);

            const posterior = (weightedSum + CONFIG.prior) / 2;

            const scoreValues = Object.values(scores);
            const variance = scoreValues.reduce((sum, s) => 
                sum + Math.pow(s - weightedSum, 2), 0) / scoreValues.length;
            const confidence = 1.0 - Math.min(variance, 0.3);

            let finalProb = posterior * confidence + CONFIG.prior * (1 - confidence);
            finalProb = Math.max(0.01, Math.min(0.99, finalProb));

            return { probability: finalProb, confidence, posterior, weightedSum };
        }

        // ============================================================================
        // AN√ÅLISIS PRINCIPAL
        // ============================================================================

        async function analyzeMarketSmart() {
            const apiKey = document.getElementById('apiKey').value.trim();
            const marketUrl = document.getElementById('marketUrl').value.trim();

            if (!apiKey) {
                alert('‚ö†Ô∏è Ingresa tu xAI API Key');
                return;
            }

            if (!marketUrl) {
                alert('‚ö†Ô∏è Ingresa la URL del mercado de Polymarket');
                return;
            }

            // Mostrar loading
            document.getElementById('inputSection').classList.add('hidden');
            document.getElementById('results').classList.add('hidden');
            document.getElementById('loading').classList.remove('hidden');
            updateProgress(10, 'Extrayendo datos del mercado con Grok...');

            // Fase 1: Extraer market data
            const marketData = await extractMarketData(marketUrl, apiKey);
            
            if (!marketData) {
                showError('No se pudo extraer la informaci√≥n del mercado. Verifica la URL.');
                return;
            }

            updateProgress(30, `Mercado detectado: ${marketData.type === 'binary' ? 'Binario (Yes/No)' : 'Multi-outcome'}`);

            // Fase 2: Buscar mercados comparables
            const comparableMarkets = await findComparableMarkets(
                marketData.title, 
                marketData.context, 
                apiKey
            );

            updateProgress(50, 'Analizando cada outcome con algoritmo bayesiano...');

            // Fase 3: Analizar cada outcome
            const marketCategory = marketData.market_category || 'default';
            const weights = WEIGHT_PROFILES[marketCategory] || WEIGHT_PROFILES.default;
            const results = [];

            for (let i = 0; i < marketData.outcomes.length; i++) {
                const outcome = marketData.outcomes[i];
                const progress = 50 + (40 * (i + 1) / marketData.outcomes.length);
                updateProgress(progress, `Analizando: ${outcome.name.substring(0, 30)}...`);

                const scores = await getGrokScores(
                    outcome.name,
                    marketData.context,
                    marketCategory,
                    apiKey
                );

                const bayesianResult = calculateBayesian(scores, weights, outcome.prob);
                const ev = bayesianResult.probability - outcome.prob;

                let verdict = '‚öñÔ∏è NEUTRAL';
                if (ev > CONFIG.evThresholdBuy) verdict = 'üî• COMPRA';
                else if (ev < CONFIG.evThresholdSkip) verdict = 'üö® SKIP';

                let bias = 'Neutral';
                const diff = bayesianResult.probability - outcome.prob;
                if (Math.abs(diff) < 0.05) bias = 'Neutral';
                else if (diff > 0.15) bias = 'Mercado Pesimista';
                else if (diff < -0.15) bias = 'Mercado Optimista';
                else if (diff > 0) bias = 'Leve subestimaci√≥n';
                else bias = 'Leve sobreestimaci√≥n';

                results.push({
                    name: outcome.name,
                    marketProb: outcome.prob,
                    ourProb: bayesianResult.probability,
                    ev: ev,
                    bias: bias,
                    verdict: verdict,
                    confidence: bayesianResult.confidence,
                    volume: outcome.volume_usd || 0,
                    scores: scores
                });

                await new Promise(resolve => setTimeout(resolve, 800));
            }

            updateProgress(100, 'Generando reporte final...');

            // Ordenar por EV
            results.sort((a, b) => b.ev - a.ev);

            // Mostrar resultados
            await new Promise(resolve => setTimeout(resolve, 500));
            displayResults(results, marketData, comparableMarkets, weights, marketCategory);
        }

        // ============================================================================
        // UI HELPERS
        // ============================================================================

        function updateProgress(percent, status) {
            document.getElementById('progressBar').style.width = `${percent}%`;
            document.getElementById('loadingStatus').textContent = status;
        }

        function showError(message) {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('inputSection').classList.remove('hidden');
            alert(`‚ùå Error: ${message}`);
        }

        // ============================================================================
        // DISPLAY RESULTADOS
        // ============================================================================

        function displayResults(results, marketData, comparableMarkets, weights, category) {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '';

            // Header del mercado
            let html = `
                <div class="bg-gradient-to-r from-cyan-500 to-blue-600 rounded-2xl p-6 border border-white/20 shadow-xl">
                    <h2 class="text-2xl font-bold text-white mb-3">üìä ${marketData.title}</h2>
                    <div class="grid grid-cols-2 gap-3 text-sm">
                        <div class="bg-white/20 rounded-lg p-3">
                            <div class="text-cyan-100 mb-1">Tipo</div>
                            <div class="text-white font-semibold">${marketData.type === 'binary' ? 'üîò Binario (Yes/No)' : 'üéØ Multi-outcome'}</div>
                        </div>
                        <div class="bg-white/20 rounded-lg p-3">
                            <div class="text-cyan-100 mb-1">Categor√≠a</div>
                            <div class="text-white font-semibold">${category.toUpperCase()}</div>
                        </div>
                    </div>
                    <div class="mt-3 text-cyan-100 text-sm">${marketData.context}</div>
                </div>
            `;

            // Comparaci√≥n con otros mercados
            if (comparableMarkets && (comparableMarkets.kalshi_exists || comparableMarkets.metaculus_exists)) {
                html += `
                    <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-6 border border-white/20 shadow-xl">
                        <h3 class="text-xl font-bold text-white mb-3 flex items-center gap-2">
                            üîÑ Comparaci√≥n con Otros Mercados
                        </h3>
                        <div class="space-y-3">
                `;

                if (comparableMarkets.kalshi_exists) {
                    html += `
                        <div class="bg-blue-900/30 border border-blue-700/50 rounded-lg p-3">
                            <div class="flex justify-between items-center">
                                <span class="text-white font-semibold">Kalshi</span>
                                <span class="text-cyan-400 text-lg">${(comparableMarkets.kalshi_prob * 100).toFixed(1)}%</span>
                            </div>
                            <div class="text-gray-300 text-xs mt-1">${comparableMarkets.kalshi_market}</div>
                        </div>
                    `;
                }

                if (comparableMarkets.metaculus_exists) {
                    html += `
                        <div class="bg-purple-900/30 border border-purple-700/50 rounded-lg p-3">
                            <div class="flex justify-between items-center">
                                <span class="text-white font-semibold">Metaculus</span>
                                <span class="text-cyan-400 text-lg">${(comparableMarkets.metaculus_prob * 100).toFixed(1)}%</span>
                            </div>
                        </div>
                    `;
                }

                html += `
                        <div class="text-gray-300 text-sm mt-2">
                            üí° ${comparableMarkets.consensus_analysis}
                        </div>
                    </div>
                </div>
                `;
            }

            // Top oportunidades
            const buys = results.filter(r => r.verdict === 'üî• COMPRA');
            if (buys.length > 0) {
                html += `
                    <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-6 border border-white/20 shadow-xl">
                        <h3 class="text-xl font-bold text-white mb-4">üî• TOP OPORTUNIDADES (${buys.length})</h3>
                        <div class="space-y-3">
                `;

                for (const r of buys.slice(0, 5)) {
                    html += `
                        <div class="bg-gradient-to-r from-green-900/40 to-emerald-900/40 border border-green-700/50 rounded-lg p-4">
                            <div class="flex justify-between items-start mb-2">
                                <span class="text-white font-semibold text-lg">${r.name}</span>
                                <span class="text-green-400 font-bold text-2xl">+${(r.ev*100).toFixed(1)}%</span>
                            </div>
                            <div class="grid grid-cols-3 gap-3 text-sm mb-2">
                                <div>
                                    <div class="text-gray-400">Mercado</div>
                                    <div class="text-white font-medium">${(r.marketProb*100).toFixed(1)}%</div>
                                </div>
                                <div>
                                    <div class="text-gray-400">Nuestra</div>
                                    <div class="text-white font-medium">${(r.ourProb*100).toFixed(1)}%</div>
                                </div>
                                <div>
                                    <div class="text-gray-400">Confianza</div>
                                    <div class="text-white font-medium">${(r.confidence*100).toFixed(0)}%</div>
                                </div>
                            </div>
                            <div class="flex justify-between items-center text-xs">
                                <span class="text-yellow-300">${r.bias}</span>
                                ${r.volume > 0 ? `<span class="text-gray-400">Vol: $${(r.volume/1000).toFixed(0)}k</span>` : ''}
                            </div>
                        </div>
                    `;
                }

                html += '</div></div>';
            }

            // Tabla completa
            html += `
                <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-6 border border-white/20 shadow-xl">
                    <h3 class="text-xl font-bold text-white mb-4">üìã An√°lisis Completo (${results.length} outcomes)</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead>
                                <tr class="border-b border-white/20">
                                    <th class="text-left text-gray-300 py-2">Outcome</th>
                                    <th class="text-right text-gray-300 py-2">Market</th>
                                    <th class="text-right text-gray-300 py-2">Nuestra</th>
                                    <th class="text-right text-gray-300 py-2">EV</th>
                                    <th class="text-center text-gray-300 py-2">Veredicto</th>
                                </tr>
                            </thead>
                            <tbody>
            `;

            for (const r of results) {
                const evColor = r.ev > 0 ? 'text-green-400' : (r.ev < 0 ? 'text-red-400' : 'text-gray-400');
                html += `
                    <tr class="border-b border-white/10 hover:bg-white/5">
                        <td class="py-3 text-white">${r.name}</td>
                        <td class="text-right text-gray-300">${(r.marketProb*100).toFixed(1)}%</td>
                        <td class="text-right text-white font-medium">${(r.ourProb*100).toFixed(1)}%</td>
                        <td class="text-right ${evColor} font-bold">${r.ev > 0 ? '+' : ''}${(r.ev*100).toFixed(1)}%</td>
                        <td class="text-center">${r.verdict}</td>
                    </tr>
                `;
            }

            html += `
                            </tbody>
                        </table>
                    </div>
                </div>
            `;

            // Portfolio sugerido
            if (buys.length > 0) {
                const totalEV = buys.reduce((sum, r) => sum + r.ev, 0);
                html += `
                    <div class="bg-gradient-to-r from-purple-900/50 to-pink-900/50 rounded-2xl p-6 border border-white/20 shadow-xl">
                        <h3 class="text-xl font-bold text-white mb-3 flex items-center gap-2">
                            üí∞ Portfolio Sugerido
                        </h3>
                        <div class="bg-green-900/30 border border-green-700/50 rounded-lg p-4 mb-4">
                            <div class="text-green-400 font-bold text-3xl mb-1">
                                EV Total: +${(totalEV*100).toFixed(1)}%
                            </div>
                            <div class="text-gray-300 text-sm">
                                Distribuye equitativamente en top ${Math.min(5, buys.length)} oportunidades
                            </div>
                        </div>
                        <div class="space-y-2">
            `;

                const topBuys = buys.slice(0, 5);
                const weight = 100 / topBuys.length;

                for (const r of topBuys) {
                    html += `
                        <div class="flex justify-between items-center bg-white/5 rounded-lg p-3">
                            <span class="text-white">${r.name.substring(0, 45)}</span>
                            <span class="text-cyan-400 font-bold">${weight.toFixed(0)}%</span>
                        </div>
                    `;
                }

                html += '</div></div>';
            }

            // Metodolog√≠a
            html += `
                <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-6 border border-white/20 shadow-xl">
                    <h3 class="text-xl font-bold text-white mb-3">üß† Metodolog√≠a</h3>
                    <div class="space-y-2 text-sm text-gray-300">
                        <div class="flex justify-between">
                            <span>Modelo:</span>
                            <span class="text-white">Bayesiano v3.0 + Grok-3</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Categor√≠as:</span>
                            <span class="text-white">7 (hist, ctx, analog, ext, mkt, sent, liq)</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Prior neutral:</span>
                            <span class="text-white">0.50</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Pesos din√°micos:</span>
                            <span class="text-white">${category.toUpperCase()}</span>
                        </div>
                    </div>
                    <div class="mt-3 pt-3 border-t border-white/20">
                        <div class="text-xs text-gray-400">
                            <strong class="text-white">Ponderaci√≥n usada:</strong><br>
                            ${Object.entries(weights).map(([k, v]) => `${k}: ${(v*100).toFixed(0)}%`).join(' | ')}
                        </div>
                    </div>
                </div>
            `;

            // Bot√≥n reset
            html += `
                <button onclick="resetAnalysis()" 
                    class="w-full bg-white/20 hover:bg-white/30 text-white py-3 px-6 rounded-xl font-semibold transition-all flex items-center justify-center gap-2 mt-4">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                    Analizar Otro Mercado
                </button>
            `;

            resultsDiv.innerHTML = html;
            document.getElementById('loading').classList.add('hidden');
            resultsDiv.classList.remove('hidden');
        }

        function resetAnalysis() {
            document.getElementById('inputSection').classList.remove('hidden');
            document.getElementById('results').classList.add('hidden');
        }
    </script>
</body>
</html>