<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#4f46e5">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>Predictor Pro AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { 
            background: linear-gradient(135deg, #1e1b4b 0%, #581c87 50%, #831843 100%);
            min-height: 100vh;
        }
    </style>
</head>
<body class="p-4">
    <div id="app" class="max-w-md mx-auto"></div>

    <script>
        // Estado global
        let state = {
            step: 0,
            eventType: '',
            scores: {},
            marketData: {},
            advancedData: {},
            result: null,
            history: []
        };

        const eventTypes = {
            'Pol√≠ticos': { hist: 0.20, ctx: 0.25, analog: 0.20, ext: 0.20, mkt: 0.15 },
            'Financieros': { hist: 0.30, ctx: 0.15, analog: 0.25, ext: 0.15, mkt: 0.15 },
            'Naturales': { hist: 0.35, ctx: 0.20, analog: 0.20, ext: 0.15, mkt: 0.10 },
            'Deportivos': { hist: 0.25, ctx: 0.20, analog: 0.25, ext: 0.15, mkt: 0.15 },
            'Cripto': { hist: 0.30, ctx: 0.15, analog: 0.25, ext: 0.15, mkt: 0.15 },
            'Otros': { hist: 0.20, ctx: 0.20, analog: 0.20, ext: 0.20, mkt: 0.20 }
        };

        const questions = [
            {
                category: 'hist',
                q1: 'Precedentes: ¬øProbabilidad hist√≥rica de √©xito?',
                help1: 'Decimal 0.00-1.00. Ej: 15/20 casos ‚Üí 0.75',
                input1: 'hist_precedent',
                q2: 'Evidencia: ¬øQu√© tan directa es la prueba?',
                help2: '0.00=Ninguna, 0.50=Parcial, 1.00=Directa',
                input2: 'hist_evidence'
            },
            {
                category: 'ctx',
                q1: 'Condiciones: ¬øProporci√≥n de condiciones presentes?',
                help1: 'Decimal 0.00-1.00. Ej: 3/4 ‚Üí 0.75',
                input1: 'ctx_conditions',
                q2: 'Catalizador: ¬øFuerza del trigger?',
                help2: '0.90=Muy fuerte, 0.50=Moderado, 0.10=D√©bil',
                input2: 'ctx_catalyst'
            },
            {
                category: 'analog',
                q1: 'Similares: Probabilidad promedio de an√°logos',
                help1: 'Decimal 0.00-1.00 de casos similares',
                input1: 'analog_prob',
                q2: 'Rareza: Factor de penalizaci√≥n',
                help2: '0.00=Com√∫n, 0.50=Inusual, 1.00=Extremadamente raro',
                input2: 'analog_rarity'
            },
            {
                category: 'ext',
                q1: 'Externos: Impacto neto de factores',
                help1: '0.80=Muy favorable, 0.50=Neutral, 0.20=Desfavorable',
                input1: 'ext_impact'
            },
            {
                category: 'mkt',
                q1: 'Mercado: Probabilidades actuales',
                help1: 'Ingresa decimales (70% = 0.70)',
                input1: 'market_probs'
            }
        ];

        // Funciones
        function loadHistory() {
            const saved = localStorage.getItem('predictor_history');
            state.history = saved ? JSON.parse(saved) : [];
        }

        function saveHistory() {
            localStorage.setItem('predictor_history', JSON.stringify(state.history));
        }

        function normalizeWeights(weights, validCategories) {
            const activeSum = validCategories.reduce((sum, cat) => sum + weights[cat], 0);
            if (activeSum === 0) return weights;
            
            const normalized = { ...weights };
            const factor = 1.0 / activeSum;
            
            Object.keys(normalized).forEach(key => {
                normalized[key] = validCategories.includes(key) ? normalized[key] * factor : 0;
            });
            
            return normalized;
        }

        function getMLAdjustedWeights(baseWeights, eventType) {
            if (state.history.length < 5) return baseWeights;

            const typeHistory = state.history.filter(h => h.eventType === eventType && h.actualOutcome !== undefined);
            if (typeHistory.length < 3) return baseWeights;

            const categoryErrors = { hist: 0, ctx: 0, analog: 0, ext: 0, mkt: 0 };
            
            typeHistory.forEach(h => {
                const error = Math.abs(h.probability - h.actualOutcome);
                Object.keys(categoryErrors).forEach(cat => {
                    categoryErrors[cat] += error * baseWeights[cat];
                });
            });

            const adjusted = { ...baseWeights };
            const avgError = Object.values(categoryErrors).reduce((a, b) => a + b) / 5;
            
            Object.keys(categoryErrors).forEach(cat => {
                if (categoryErrors[cat] > avgError * 1.2) {
                    adjusted[cat] *= 0.85;
                } else if (categoryErrors[cat] < avgError * 0.8) {
                    adjusted[cat] *= 1.10;
                }
            });

            const sum = Object.values(adjusted).reduce((a, b) => a + b);
            Object.keys(adjusted).forEach(cat => adjusted[cat] /= sum);

            return adjusted;
        }

        function calculateProbability() {
            const baseWeights = eventTypes[state.eventType];
            const validCategories = [];
            const categoryScores = {};

            // Hist√≥rico
            const histPrecedent = parseFloat(state.scores.hist_precedent);
            const histEvidence = parseFloat(state.scores.hist_evidence);
            if (!isNaN(histPrecedent) || !isNaN(histEvidence)) {
                validCategories.push('hist');
                const validScores = [histPrecedent, histEvidence].filter(s => !isNaN(s));
                categoryScores.hist = validScores.reduce((a, b) => a + b, 0) / validScores.length;
            }

            // Contexto
            const ctxConditions = parseFloat(state.scores.ctx_conditions);
            const ctxCatalyst = parseFloat(state.scores.ctx_catalyst);
            if (!isNaN(ctxConditions) || !isNaN(ctxCatalyst)) {
                validCategories.push('ctx');
                const validScores = [ctxConditions, ctxCatalyst].filter(s => !isNaN(s));
                categoryScores.ctx = validScores.reduce((a, b) => a + b, 0) / validScores.length;
            }

            // An√°logos
            const analogProb = parseFloat(state.scores.analog_prob);
            const analogRarity = parseFloat(state.scores.analog_rarity);
            if (!isNaN(analogProb) || !isNaN(analogRarity)) {
                validCategories.push('analog');
                const prob = !isNaN(analogProb) ? analogProb : 0.5;
                const rarityPenalty = !isNaN(analogRarity) ? (1 - analogRarity) : 1.0;
                categoryScores.analog = prob * rarityPenalty;
            }

            // Externos
            const extImpact = parseFloat(state.scores.ext_impact);
            if (!isNaN(extImpact)) {
                validCategories.push('ext');
                categoryScores.ext = extImpact;
            }

            // Mercado
            const marketProbs = [
                parseFloat(state.marketData.polymarket),
                parseFloat(state.marketData.kalshi),
                parseFloat(state.marketData.metaculus)
            ].filter(p => !isNaN(p));
            
            if (marketProbs.length > 0) {
                validCategories.push('mkt');
                const marketAvg = marketProbs.reduce((a, b) => a + b) / marketProbs.length;
                const volume = parseFloat(state.marketData.volume) || 0;
                const liquidityFactor = volume >= 10000 ? 1.0 : (volume >= 5000 ? 0.7 : 0.4);
                categoryScores.mkt = marketAvg * liquidityFactor + 0.5 * (1 - liquidityFactor);
            }

            let weights = normalizeWeights(baseWeights, validCategories);
            weights = getMLAdjustedWeights(weights, state.eventType);

            let totalScore = 0;
            validCategories.forEach(cat => {
                totalScore += weights[cat] * categoryScores[cat];
            });

            const dataPoints = validCategories.length;
            const confidenceFactor = dataPoints >= 4 ? 1.0 : (dataPoints >= 3 ? 0.95 : 0.90);
            
            let finalProb = totalScore * confidenceFactor;

            // Factores avanzados
            const sentiment = parseFloat(state.advancedData.sentiment) || 0.5;
            finalProb += (sentiment - 0.5) * 0.10;

            const momentum = parseFloat(state.advancedData.momentum);
            if (!isNaN(momentum)) {
                finalProb += (momentum - 0.5) * 0.05;
            }

            const manipulation = parseFloat(state.advancedData.manipulation);
            if (!isNaN(manipulation) && manipulation > 0.5) {
                finalProb *= (1 - (manipulation - 0.5) * 0.2);
            }

            finalProb = Math.min(Math.max(finalProb, 0.01), 0.99);

            const polyProb = parseFloat(state.marketData.polymarket) || finalProb;
            const ev = finalProb - polyProb;

            let bias = 'Neutral';
            let biasDetail = '';
            if (Math.abs(ev) > 0.10) {
                bias = ev > 0 ? 'Mercado Pesimista' : 'Mercado Optimista';
                biasDetail = ev > 0 
                    ? 'El mercado subestima ~' + Math.abs(ev * 100).toFixed(0) + '%. Oportunidad.'
                    : 'El mercado sobreestima ~' + Math.abs(ev * 100).toFixed(0) + '%. Skip.';
            } else if (Math.abs(ev) > 0.05) {
                bias = ev > 0 ? 'Leve subestimaci√≥n' : 'Leve sobreestimaci√≥n';
                biasDetail = 'Desviaci√≥n moderada de ' + Math.abs(ev * 100).toFixed(1) + '%';
            } else {
                biasDetail = 'Precio justo.';
            }

            const userHistory = state.history.filter(h => h.actualOutcome !== undefined);
            const brierScore = userHistory.length > 0
                ? userHistory.reduce((sum, h) => sum + Math.pow(h.probability - h.actualOutcome, 2), 0) / userHistory.length
                : null;

            state.result = {
                probability: finalProb,
                ev: ev,
                bias: bias,
                biasDetail: biasDetail,
                marketConsensus: polyProb,
                confidenceFactor: confidenceFactor,
                brierScore: brierScore,
                recommendation: ev > 0.08 ? 'APOSTAR' : (ev < -0.08 ? 'SKIP' : 'NEUTRAL'),
                eventType: state.eventType,
                timestamp: Date.now(),
                weights: weights,
                validCategories: validCategories,
                sentiment: sentiment,
                momentum: !isNaN(momentum) ? momentum : null,
                manipulation: !isNaN(manipulation) ? manipulation : null
            };

            state.history.push(state.result);
            saveHistory();
        }

        function recordOutcome(outcome) {
            if (state.result) {
                state.result.actualOutcome = outcome;
                saveHistory();
                alert(outcome === 1 ? '‚úÖ Resultado: Ocurri√≥' : '‚ùå Resultado: No ocurri√≥');
                loadHistory();
                render();
            }
        }

        function reset() {
            state = {
                step: 0,
                eventType: '',
                scores: {},
                marketData: {},
                advancedData: {},
                result: null,
                history: state.history
            };
            render();
        }

        // Renderizado
        function render() {
            const app = document.getElementById('app');
            
            if (state.step === 0) {
                app.innerHTML = `
                    <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-6 mb-4 border border-white/20">
                        <div class="flex items-center gap-3 mb-2">
                            <div class="text-4xl">üìä</div>
                            <h1 class="text-2xl font-bold text-white">Predictor Pro AI</h1>
                        </div>
                        <p class="text-gray-300 text-sm">Algoritmo Bayesiano + ML</p>
                        ${state.history.length > 0 ? `
                            <div class="mt-2 text-xs text-cyan-400">
                                ${state.history.length} predicciones | Brier: ${
                                    state.history.filter(h => h.actualOutcome !== undefined).length > 0
                                        ? (state.history.filter(h => h.actualOutcome !== undefined)
                                            .reduce((sum, h) => sum + Math.pow(h.probability - h.actualOutcome, 2), 0) / 
                                            state.history.filter(h => h.actualOutcome !== undefined).length).toFixed(3)
                                        : 'N/A'
                                }
                            </div>
                        ` : ''}
                    </div>
                    <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-6 border border-white/20">
                        <h2 class="text-xl font-semibold text-white mb-4">Tipo de Evento</h2>
                        <div class="grid grid-cols-2 gap-3">
                            ${Object.keys(eventTypes).map(type => `
                                <button onclick="selectType('${type}')" 
                                    class="bg-gradient-to-r from-cyan-500 to-blue-500 hover:from-cyan-600 hover:to-blue-600 text-white py-4 px-4 rounded-xl font-medium transition-all transform hover:scale-105">
                                    ${type}
                                </button>
                            `).join('')}
                        </div>
                    </div>
                `;
            } else if (state.step >= 1 && state.step <= 5) {
                const q = questions[state.step - 1];
                app.innerHTML = `
                    <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-6 border border-white/20">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-lg font-semibold text-white">
                                ${['Hist√≥rico', 'Contexto', 'An√°logos', 'Externos', 'Mercado'][state.step - 1]}
                            </h2>
                            <span class="text-cyan-400 font-bold">${state.step}/5</span>
                        </div>
                        <div class="space-y-4">
                            <div>
                                <label class="text-white font-medium block mb-2">${q.q1}</label>
                                <p class="text-gray-400 text-sm mb-2">${q.help1}</p>
                                <input type="number" step="0.01" min="0" max="1" placeholder="0.00 - 1.00"
                                    id="${q.input1}"
                                    class="w-full bg-white/20 border border-white/30 rounded-lg px-4 py-3 text-white placeholder-gray-400">
                            </div>
                            ${q.q2 ? `
                                <div>
                                    <label class="text-white font-medium block mb-2">${q.q2}</label>
                                    <p class="text-gray-400 text-sm mb-2">${q.help2}</p>
                                    <input type="number" step="0.01" min="0" max="1" placeholder="0.00 - 1.00"
                                        id="${q.input2}"
                                        class="w-full bg-white/20 border border-white/30 rounded-lg px-4 py-3 text-white placeholder-gray-400">
                                </div>
                            ` : ''}
                            <div class="text-yellow-300 text-xs bg-yellow-900/20 p-2 rounded">
                                üí° Puedes dejar campos vac√≠os. Los pesos se redistribuir√°n.
                            </div>
                        </div>
                        <button onclick="nextStep()" 
                            class="w-full bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-600 hover:to-emerald-600 text-white py-3 px-6 rounded-xl font-semibold mt-6 transition-all">
                            Siguiente ‚Üí
                        </button>
                    </div>
                `;
            } else if (state.step === 6) {
                app.innerHTML = `
                    <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-6 border border-white/20">
                        <h2 class="text-xl font-semibold text-white mb-4">üìà Datos de Mercado</h2>
                        <div class="space-y-4">
                            <div>
                                <label class="text-white font-medium block mb-2">Polymarket</label>
                                <input type="number" step="0.01" min="0" max="1" placeholder="0.65" id="polymarket"
                                    class="w-full bg-white/20 border border-white/30 rounded-lg px-4 py-3 text-white">
                            </div>
                            <div>
                                <label class="text-white font-medium block mb-2">Kalshi (opcional)</label>
                                <input type="number" step="0.01" min="0" max="1" placeholder="0.68" id="kalshi"
                                    class="w-full bg-white/20 border border-white/30 rounded-lg px-4 py-3 text-white">
                            </div>
                            <div>
                                <label class="text-white font-medium block mb-2">Metaculus (opcional)</label>
                                <input type="number" step="0.01" min="0" max="1" placeholder="0.72" id="metaculus"
                                    class="w-full bg-white/20 border border-white/30 rounded-lg px-4 py-3 text-white">
                            </div>
                            <div>
                                <label class="text-white font-medium block mb-2">Volumen USD</label>
                                <input type="number" placeholder="25000" id="volume"
                                    class="w-full bg-white/20 border border-white/30 rounded-lg px-4 py-3 text-white">
                            </div>
                        </div>
                        <button onclick="nextStep()" 
                            class="w-full bg-gradient-to-r from-purple-500 to-pink-500 text-white py-3 rounded-xl font-semibold mt-6">
                            Siguiente ‚Üí
                        </button>
                    </div>
                `;
            } else if (state.step === 7) {
                app.innerHTML = `
                    <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-6 border border-white/20">
                        <h2 class="text-xl font-semibold text-white mb-4">üß† Factores Avanzados</h2>
                        <div class="space-y-4">
                            <div>
                                <label class="text-white font-medium block mb-2">üí¨ Sentiment</label>
                                <p class="text-gray-400 text-xs mb-2">0.80+=Bullish, 0.50=Neutral, 0.20-=Bearish</p>
                                <input type="number" step="0.01" min="0" max="1" placeholder="0.50" id="sentiment"
                                    class="w-full bg-white/20 border border-white/30 rounded-lg px-4 py-3 text-white">
                            </div>
                            <div>
                                <label class="text-white font-medium block mb-2">‚ö° Momentum</label>
                                <p class="text-gray-400 text-xs mb-2">0.80+=Acelerando, 0.20-=Frenando</p>
                                <input type="number" step="0.01" min="0" max="1" placeholder="0.50" id="momentum"
                                    class="w-full bg-white/20 border border-white/30 rounded-lg px-4 py-3 text-white">
                            </div>
                            <div>
                                <label class="text-white font-medium block mb-2">‚ö†Ô∏è Manipulaci√≥n</label>
                                <p class="text-gray-400 text-xs mb-2">0.00=Limpio, 1.00=Manipulado</p>
                                <input type="number" step="0.01" min="0" max="1" placeholder="0.00" id="manipulation"
                                    class="w-full bg-white/20 border border-white/30 rounded-lg px-4 py-3 text-white">
                            </div>
                        </div>
                        <button onclick="calculate()" 
                            class="w-full bg-gradient-to-r from-purple-500 to-pink-500 text-white py-4 rounded-xl font-bold mt-6">
                            üéØ Calcular con IA
                        </button>
                    </div>
                `;
            } else if (state.step === 8 && state.result) {
                const r = state.result;
                app.innerHTML = `
                    <div class="space-y-4">
                        <div class="bg-gradient-to-r from-cyan-500 to-blue-500 rounded-2xl p-6">
                            <h2 class="text-white text-sm font-medium mb-2">Probabilidad Calculada</h2>
                            <div class="text-5xl font-bold text-white mb-2">${(r.probability * 100).toFixed(1)}%</div>
                            <div class="text-cyan-100 text-sm">vs Mercado: ${(r.marketConsensus * 100).toFixed(1)}%</div>
                        </div>
                        
                        <div class="rounded-2xl p-6 ${
                            r.recommendation === 'APOSTAR' ? 'bg-gradient-to-r from-green-600 to-emerald-600' :
                            r.recommendation === 'SKIP' ? 'bg-gradient-to-r from-red-600 to-rose-600' :
                            'bg-gradient-to-r from-gray-600 to-gray-700'
                        }">
                            <div class="flex justify-between mb-2">
                                <span class="text-white font-bold text-xl">${r.recommendation}</span>
                                <span class="text-white text-2xl font-bold">EV: ${r.ev >= 0 ? '+' : ''}${(r.ev * 100).toFixed(1)}%</span>
                            </div>
                            <div class="text-white/90 text-sm">${r.biasDetail}</div>
                        </div>

                        ${r.brierScore !== null ? `
                            <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-4">
                                <div class="text-white font-semibold mb-2">Tu Brier Score: ${r.brierScore.toFixed(3)}</div>
                                <div class="text-gray-300 text-xs">
                                    ${r.brierScore < 0.15 ? 'üéØ Excelente' : r.brierScore < 0.25 ? '‚ö†Ô∏è Bueno' : '‚ùå Necesitas mejorar'}
                                </div>
                            </div>
                        ` : ''}

                        <div class="bg-gradient-to-r from-orange-600 to-red-600 rounded-2xl p-6">
                            <h3 class="text-white font-semibold mb-3">üìä Registra Resultado</h3>
                            <div class="flex gap-3">
                                <button onclick="recordOutcome(1)" 
                                    class="flex-1 bg-green-500 hover:bg-green-600 text-white py-3 rounded-xl font-medium">
                                    ‚úÖ Ocurri√≥
                                </button>
                                <button onclick="recordOutcome(0)" 
                                    class="flex-1 bg-red-500 hover:bg-red-600 text-white py-3 rounded-xl font-medium">
                                    ‚ùå No Ocurri√≥
                                </button>
                            </div>
                        </div>

                        <button onclick="reset()" 
                            class="w-full bg-white/20 hover:bg-white/30 text-white py-3 rounded-xl font-semibold">
                            üîÑ Nueva Predicci√≥n
                        </button>
                    </div>
                `;
            }
        }

        // Event handlers
        window.selectType = (type) => {
            state.eventType = type;
            state.step = 1;
            render();
        };

        window.nextStep = () => {
            if (state.step >= 1 && state.step <= 5) {
                const q = questions[state.step - 1];
                const v1 = document.getElementById(q.input1)?.value;
                if (v1) state.scores[q.input1] = v1;
                if (q.input2) {
                    const v2 = document.getElementById(q.input2)?.value;
                    if (v2) state.scores[q.input2] = v2;
                }
            } else if (state.step === 6) {
                state.marketData.polymarket = document.getElementById('polymarket')?.value || '';
                state.marketData.kalshi = document.getElementById('kalshi')?.value || '';
                state.marketData.metaculus = document.getElementById('metaculus')?.value || '';
                state.marketData.volume = document.getElementById('volume')?.value || '';
            }
            state.step++;
            render();
        };

        window.calculate = () => {
            state.advancedData.sentiment = document.getElementById('sentiment')?.value || '';
            state.advancedData.momentum = document.getElementById('momentum')?.value || '';
            state.advancedData.manipulation = document.getElementById('manipulation')?.value || '';
            calculateProbability();
            state.step = 8;
            render();
        };

        window.recordOutcome = recordOutcome;
        window.reset = reset;

        // Init
        loadHistory();
        render();
    </script>
</body>
</html>